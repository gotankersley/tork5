var HI_MASK=4294967296,BIT_COUNTS=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4],IND_TO_MPOS=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648,4294967296,8589934592,17179869184,34359738368],MPOS_TO_IND={1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:7,256:8,512:9,1024:10,2048:11,4096:12,8192:13,16384:14,32768:15,65536:16,131072:17,262144:18,524288:19,1048576:20,2097152:21,4194304:22,
8388608:23,16777216:24,33554432:25,67108864:26,134217728:27,268435456:28,536870912:29,1073741824:30,2147483648:31,4294967296:32,8589934592:33,17179869184:34,34359738368:35},HI_MPOS_TO_IND=[[],[32],[33],[32,33],[34],[32,34],[33,34],[32,33,34],[35],[32,35],[33,35],[32,33,35],[34,35],[32,34,35],[33,34,35],[32,33,34,35]];function xor(a,b){return(a/HI_MASK^b/HI_MASK)*HI_MASK+((a^b)>>>0)}function and(a,b){return(Math.floor(a/HI_MASK)&Math.floor(b/HI_MASK))*HI_MASK+((a&b)>>>0)}
function or(a,b){return(Math.floor(a/HI_MASK)|Math.floor(b/HI_MASK))*HI_MASK+((a|b)>>>0)}function not(a){return(~Math.floor(a/HI_MASK)>>>0^4294967280)*HI_MASK+(~a>>>0)}function shiftL(a,b){return Math.floor(a*Math.pow(2,b))}function shiftR(a,b){return Math.floor(a/Math.pow(2,b))}function rotL(a,b){return a>>>32-b|(a<<b)%255}function rotR(a,b){return a>>>b|(a<<32-b>>>0)%255}
function bitCount(a){var b=BIT_COUNTS[Math.floor(a/HI_MASK)];a-=a>>>1&1431655765;a=(a&858993459)+(a>>>2&858993459);return b+(16843009*(a+(a>>>4)&252645135)>>>24)}function bitScan(a){bits=[];var b=Math.floor(a/HI_MASK);for(a%=HI_MASK;a;)bits.push(MPOS_TO_IND[(a&-a)>>>0]),a&=a-1;return bits.concat(HI_MPOS_TO_IND[b])};var AVAIL_WINS=[[1543,1729,6151,98311,33816769,33816583,1573057,25166017,34493956369,34896609553,42949673233],[3590,14342,98822,1543,6151,98311,67633442,69206306,100663586,1342210058,1342210178,5368741898,17448337418],[3590,14342,98822,1543,1564,6151,98311,3145756,3145735,12582940,786460],[200968,148744,197E3,132488,147848,7340056,29360152,1835032,3145756,12582940,786460,1342210058,1342210088,5368741898,17448337418],[57392,98864,14384,49264,49180,66160,12400,7340056,29360152,1835032,3145756,3145840,
12582940,786460,36641440016,43486544144,34493956369,34896609553,42949673233,34145296,34083856,34160656,2688016,42009616],[57392,98864,14384,49264,66160,12400,76022048,102760736,67633442,69206306,100663586,21475885216,21475885096,17449353376,5369757856],[49264,49345,66160,12400,50593984,1835200,29360320,33816769,33816688,1573057,25166017],[197E3,132488,147848,50593984,1835200,29360320,33816769,1573057,25166017,21475885216,21475885186,17449353376,5369757856],[200968,200992,200962,148744,197E3,196898,
132488,147848,76022048,76022144,76022024,102760736,67633442,67633544,69206306,100663586,36641440016,36641440064,36641440004,43486544144,34493956369,34493956420,34896609553,42949673233],[3590,3608,3713,98822,1543,1564,1729,17314185728,17314090496,805405184,12885000704],[3590,3608,3713,1543,1564,1729,34628322304,35433628672,51539756032,34145296,34083856,2688016,42009616],[3590,3608,3713,14342,1610627072,1610616320,6442465280,402667520,68323328,71469056,67536896],[200968,200992,200962,3758108672,15032397824,
939536384,1610627072,6442465280,402667520,144723968,144708608,176181248,136859648],[57392,57536,57356,14384,3758108672,15032397824,939536384,1610627072,1610670080,6442465280,402667520],[57392,57536,57356,49264,49345,49180,38923288576,52613496832,34628322304,35433628672,51539756032,144723968,144785408,176181248,136859648],[57392,57536,57356,98864,49264,49345,49180,25904119808,939622400,15032483840,17314185728,17314144256,805405184,12885000704,1342210058,1342210088,1342210178,5368741898,17448337418,
85098496,71729152,68323328,71469056,67536896],[200968,200992,200962,197E3,196898,25904119808,939622400,15032483840,17314185728,805405184,12885000704,34145296,34160656,2688016,42009616],[200968,200992,200962,148744,197E3,196898,132488,147848,38923288576,38923337728,38923276288,52613496832,34628322304,34628374528,35433628672,51539756032,85098496,85066240,85073920,71729152,68323328,68297216,71469056,67536896],[404488192,453246976,1612447744,25771638784,50593984,50593795,50593840,1835200,33816769,33816583,
33816688],[941096960,3759669248,25905594368,404488192,1612447744,25771638784,76022048,76022144,76022024,67633442,67633544,34145296,34083856,34160656,2688016],[941096960,3759669248,25905594368,404488192,409993216,1612447744,25771638784,7340056,7340128,7340038,1835032,3145756,3145840,3145735,21475885216,21475885186,21475885096,17449353376,5369757856,85098496,85066240,85073920,68323328,68297216],[52682555392,38992347136,51642368E3,34730934272,38757466112,7340056,7340128,7340038,3145756,3145840,3145735,
144723968,144785408,144708608,136859648],[15044968448,25916604416,3770679296,12914262016,12892241920,17343447040,3250585600,7340056,7340128,7340038,29360152],[15044968448,25916604416,3770679296,12914262016,17343447040,3250585600,76022048,76022144,76022024,144723968,144785408,144708608,176181248],[12914262016,12935495680,17343447040,3250585600,50593984,50593795,50593840,29360320,85098496,85066240,85073920],[51642368E3,34730934272,38757466112,50593984,50593795,50593840,33816769,33816583,33816688,34145296,
34083856,34160656,42009616],[52682555392,52688846848,52680982528,38992347136,51642368E3,51615629312,34730934272,38757466112,76022048,76022144,76022024,102760736,67633442,67633544,69206306,100663586,85098496,85066240,85073920,71729152,68323328,68297216,71469056,67536896],[941096960,945815552,973340672,25905594368,404488192,409993216,453246976,25904119808,25904023040,25904046080,939622400,17314185728,17314090496,17314144256,36641440016,36641440064,36641440004,34493956369,34493956420,144723968,144785408,
144708608,176181248,136859648],[941096960,945815552,973340672,404488192,409993216,453246976,38923288576,38923337728,38923276288,34628322304,34628374528,1342210058,1342210088,1342210178,17448337418],[941096960,945815552,973340672,3759669248,3758108672,3758145536,3758099456,939536384,1610627072,1610670080,1610616320],[52682555392,52688846848,52680982528,3758108672,3758145536,3758099456,1610627072,1610670080,1610616320,1342210058,1342210088,1342210178,5368741898],[15044968448,15082717184,15035531264,
3770679296,3758108672,3758145536,3758099456,15032397824,36641440016,36641440064,36641440004],[15044968448,15082717184,15035531264,12914262016,12935495680,12892241920,38923288576,38923337728,38923276288,21475885216,21475885186,21475885096,5369757856],[15044968448,15082717184,15035531264,25916604416,12914262016,12935495680,12892241920,25904119808,25904023040,25904046080,15032483840],[52682555392,52688846848,52680982528,51642368E3,51615629312,25904119808,25904023040,25904046080,17314185728,17314090496,
17314144256,21475885216,21475885186,21475885096,17449353376],[52682555392,52688846848,52680982528,38992347136,51642368E3,51615629312,34730934272,38757466112,38923288576,38923337728,38923276288,52613496832,34628322304,34628374528,35433628672,51539756032,36641440016,36641440064,36641440004,43486544144,34493956369,34493956420,34896609553,42949673233]];var WIN_META={1564:[0,1],1729:[0,0],3608:[0,1],3713:[0,0],6151:[1,1],12400:[1,0],14342:[1,1],14384:[1,0],49180:[0,0],49345:[0,1],57356:[0,0],57536:[0,1],66160:[1,1],98311:[1,0],98822:[1,0],98864:[1,1],132488:[1,1],147848:[1,0],148744:[1,0],196898:[0,0],200962:[0,0],200992:[0,1],786460:[2,0],1573057:[2,1],1835032:[2,0],1835200:[2,1],2688016:[2,1],3145735:[0,0],3145840:[0,1],7340038:[0,0],7340128:[0,1],12582940:[2,1],25166017:[2,0],29360152:[2,1],29360320:[2,0],33816583:[0,1],33816688:[0,0],34083856:[1,
1],34160656:[1,0],42009616:[2,0],50593795:[0,1],50593840:[0,0],67536896:[2,0],67633544:[0,0],68297216:[1,0],69206306:[2,1],71469056:[2,1],71729152:[2,0],76022024:[0,0],76022144:[0,1],85066240:[1,1],85073920:[1,0],100663586:[2,0],102760736:[2,0],136859648:[2,0],144708608:[1,0],144785408:[1,1],176181248:[2,1],402667520:[3,0],409993216:[2,1],453246976:[2,0],805405184:[3,1],939536384:[3,0],939622400:[3,1],945815552:[2,1],973340672:[2,0],1342210088:[0,1],1342210178:[0,0],1610616320:[1,0],1610670080:[1,
1],1612447744:[3,1],3250585600:[3,0],3758099456:[1,0],3758145536:[1,1],3759669248:[3,1],3770679296:[3,0],34896609553:[3,1],42949673233:[3,0],5368741898:[3,1],17448337418:[3,0],17314090496:[1,1],12885000704:[3,0],35433628672:[3,1],51539756032:[3,0],6442465280:[3,1],21475885186:[0,1],17449353376:[3,1],5369757856:[3,0],36641440064:[0,1],36641440004:[0,0],43486544144:[3,0],34493956420:[0,0],15032483840:[3,0],38923337728:[1,1],38923276288:[1,0],52613496832:[3,0],34628374528:[1,0],15032397824:[3,1],21475885096:[0,
0],17314144256:[1,0],25771638784:[3,0],25905594368:[3,0],25904023040:[1,1],25904046080:[1,0],34730934272:[3,1],38757466112:[3,0],52688846848:[2,1],52680982528:[2,0],38992347136:[3,0],51615629312:[2,0],12935495680:[2,1],17343447040:[3,1],25916604416:[3,1],12892241920:[2,0],15082717184:[2,1],15035531264:[2,0]};var QUAD_MID_WINS=[1560,196896,49344,33816579,67633536,3145824,1342210088,34493956416,21475885186,34145344,1665,196866,49164,33816624,67633416,3145734,1342210178,34493956356,21475885096,34145284,6150,132360,66096,17314088448,34628370432,1610661888,1342177802,34083856,68289024,144785408,98310,147720,12336,17314111488,34628308992,1610615808,1342185482,34160656,68296704,144708608,408944640,51615105024,12935233536,1573056,69206304,12582936,21479030944,2688016,71467008,176181248,436469760,51607240704,
12888047616,25166016,100663584,786456,21475098784,42009616,67534848,136859648,1612185600,34697379840,17326669824,805404672,35433627648,6442463232,5368741898,34896609552,17449353376,547377152,25771376640,38723911680,3233808384,12885000192,51539755008,402665472,17448337418,42949673232,5369757856,8600440832],QUAD_SPAN_WINS=[2052,4098,8193,16777220,8388616,4194320,1073741832,2147483652,4294967298,33555456,2112,4128,8208,16777280,8388736,4194305,1073741952,2147483712,4294967328,33555456,8193,16512,32832,
8589936640,4294971392,2147491840,1073741826,33558528,16785408,8404992,513,1152,2112,8589967360,4295032832,2147484160,1073741826,33619968,16777728,8389632,537919488,1074266112,2147745792,262145,33554434,16777220,4294967424,525312,264192,33558528,553648128,1082130432,2151677952,4194305,2097154,1048580,4294967424,8389632,4196352,2101248,2147745792,4328521728,8606711808,134218240,17179870208,8589936640,4294967298,8589934593,17179869312,8392704,134479872,301989888,553648128,2147484160,1073742848,536872960,
268435458,536870913,1073741952,8392704];var MID_WINS=[1542,196872,49200,404226048,51608813568,12897484800,33816768,67633440,3145752,17314185216,34628321280,1610625024,1342210058,34493956368,21475885216,34145296,68321280,144723968],SPAN_WINS=[2049,4224,8256,537133056,1107296256,2164260864,16777217,8388610,4194308,8589935104,4294968320,2147485696,1073741826,2147483649,4294967424,33555456,16779264,8392704],LONG_MID_WINS=[1560,196896,49344,33816579,67633536,3145824,34493956416,1665,196866,49164,33816624,67633416,3145734,34493956356,6150,132360,
66096,17314088448,34628370432,1610661888,68289024,98310,147720,12336,17314111488,34628308992,1610615808,68296704,408944640,51615105024,12935233536,1573056,69206304,12582936,71467008,436469760,51607240704,12888047616,25166016,100663584,786456,67534848,1612185600,34697379840,17326669824,805404672,35433627648,6442463232,34896609552,25771376640,38723911680,3233808384,12885000192,51539755008,402665472,42949673232,1542,196872,49200,404226048,51608813568,12897484800,33816768,67633440,3145752,17314185216,
34628321280,1610625024,34493956368,68321280],LONG_SPAN_WINS=[2052,4098,8193,16777220,8388616,4194320,2147483652,2112,4128,8208,16777280,8388736,4194305,2147483712,8193,16512,32832,8589936640,4294971392,2147491840,16785408,513,1152,2112,8589967360,4295032832,2147484160,16777728,537919488,1074266112,2147745792,262145,33554434,16777220,264192,553648128,1082130432,2151677952,4194305,2097154,1048580,4196352,2147745792,4328521728,8606711808,134218240,17179870208,8589936640,8589934593,134479872,301989888,
553648128,2147484160,1073742848,536872960,536870913,2049,4224,8256,537133056,1107296256,2164260864,16777217,8388610,4194308,8589935104,4294968320,2147485696,2147483649,16779264],SHORT_WINS=[1342210088,21475885186,34145344,1342210178,21475885096,34145284,1342177802,34083856,144785408,1342185482,34160656,144708608,21479030944,2688016,176181248,21475098784,42009616,136859648,5368741898,17449353376,547377152,17448337418,5369757856,8600440832,1342210058,21475885216,34145296,144723968];var BOARD_SPACES=36,BOARD_QUADS=4,NUM_TO_WIN=5,ROW_SPACES=6,COL_SPACES=6,QUAD_SPACES=9,QUAD_COUNT=2,QUAD_ROW_SPACES=3,QUAD_COL_SPACES=3,ALL_ROTATIONS=8,PLAYER1=0,PLAYER2=1,EMPTY=-1,ROT_CLOCKWISE=0,ROT_ANTICLOCKWISE=1,IN_PLAY=0,WIN_PLAYER1=1,WIN_PLAYER2=2,WIN_TIE=3,WIN_DUAL=4,ROW=[0,0,0,1,2,2,2,1,1,0,0,0,1,2,2,2,1,1,3,3,3,4,5,5,5,4,4,3,3,3,4,5,5,5,4,4],COL=[0,1,2,2,2,1,0,0,1,3,4,5,5,5,4,3,3,4,0,1,2,2,2,1,0,0,1,3,4,5,5,5,4,3,3,4],IND=[[0,1,2,9,10,11],[7,8,3,16,17,12],[6,5,4,15,14,13],[18,19,20,27,28,
29],[25,26,21,34,35,30],[24,23,22,33,32,31]],FULL=68719476735,INITIAL=0,QUADS=[255,130560,66846720,34225520640],WINS=[1543,3590,197E3,200968,49264,57392,404488192,941096960,51642368E3,52682555392,12914262016,15044968448,33816769,50593984,67633442,76022048,3145756,7340056,17314185728,25904119808,34628322304,38923288576,1610627072,3758108672,1342210058,34493956369,36641440016,21475885216,34145296,68323328,85098496,144723968];function Board(){this.p2=this.p1=INITIAL;this.turn=PLAYER1}
Board.prototype.isOpen=function(a){var b=not(or(this.p1,this.p2));return and(b,IND_TO_MPOS[a])};Board.prototype.set=function(a,b){return this.setPin(IND[a][b])};Board.prototype.setPin=function(a){return this.isOpen(a)?(this.turn==PLAYER1?this.p1=xor(this.p1,IND_TO_MPOS[a]):this.p2=xor(this.p2,IND_TO_MPOS[a]),!0):!1};Board.prototype.get=function(a,b){return this.getPin(IND[a][b])};Board.prototype.getPin=function(a){a=IND_TO_MPOS[a];return and(this.p1,a)?PLAYER1:and(this.p2,a)?PLAYER2:EMPTY};
Board.prototype.getOpen=function(){var a=[],b=not(or(this.p1,this.p2)),b=bitScan(b),c;for(c in b)a.push(b[c]);return a};Board.prototype.rotate=function(a,b){this.p1=this.rotateQuad(this.p1,a,b);this.p2=this.rotateQuad(this.p2,a,b);this.turn=!this.turn};Board.prototype.rotateQuad=function(a,b,c){var d=and(a,QUADS[b]),d=shiftR(d,b*QUAD_SPACES);c=c==ROT_CLOCKWISE?rotL(d,QUAD_COUNT):rotR(d,QUAD_COUNT);c=shiftL(c,b*QUAD_SPACES);a=and(a,not(QUADS[b]));return xor(a,c)};
Board.prototype.isWin=function(){var a=bitCount(or(this.p1,this.p2));if(a>=BOARD_SPACES)return WIN_TIE;if(a<NUM_TO_WIN)return IN_PLAY;var b=a=!1,c;for(c in MID_WINS){var d=MID_WINS[c];and(this.p1,d)==d&&and(this.p1,SPAN_WINS[c])?a=!0:and(this.p2,d)==d&&and(this.p2,SPAN_WINS[c])&&(b=!0)}return a&&b?WIN_DUAL:a?WIN_PLAYER1:b?WIN_PLAYER2:IN_PLAY};
Board.prototype.getWinLines=function(a){a=[[],[]];for(var b in MID_WINS){var c=MID_WINS[b];if(and(this.p1,c)==c&&and(this.p1,SPAN_WINS[b])){var d=and(this.p1,SPAN_WINS[b]);a[PLAYER1].push(this.getWinLine(or(c,d)))}else and(this.p2,c)==c&&and(this.p2,SPAN_WINS[b])&&(d=and(this.p2,SPAN_WINS[b]),a[PLAYER2].push(this.getWinLine(or(c,d))))}return a};
Board.prototype.getWinLine=function(a){var b=ROW_SPACES-1,c=COL_SPACES-1,d=0,e=0,g,f=bitScan(a),h;for(h in f){g=f[h];a=ROW[g];g=COL[g];if(a<b||a==b&&g<c)b=a,c=g;if(a>d||a==d&&g>e)d=a,e=g}return[b,c,d,e]};
Board.prototype.makeRandomMove=function(){var a=not(or(this.p1,this.p2)),a=bitScan(a),a=a[Math.floor(Math.random()*a.length)];this.turn==PLAYER1?this.p1=xor(this.p1,IND_TO_MPOS[a]):this.p2=xor(this.p2,IND_TO_MPOS[a]);var a=Math.floor(Math.random()*BOARD_QUADS),b=Math.floor(2*Math.random());this.rotate(a,b)};
Board.prototype.getAllNonLossMoves=function(){var a,b,c={};this.turn==PLAYER1?(a=this.p1,b=this.p2):(a=this.p2,b=this.p1);var d=this.findOppRotateWins(b);a=not(or(a,b));a=bitScan(a);for(var e in a)for(b=0;b<ALL_ROTATIONS;b++)if(!d[b]){var g=Math.floor(b/2),f=b%2,h=this.clone();h.turn==PLAYER1?h.p1=xor(h.p1,IND_TO_MPOS[a[e]]):h.p2=xor(h.p2,IND_TO_MPOS[a[e]]);h.rotate(g,f);c[String(h.p1)+"_"+String(h.p2)]=h}return c};
Board.prototype.findOppRotateWins=function(a){var b=[0,0,0,0,0,0,0,0],c;for(c in QUAD_MID_WINS){var d=QUAD_MID_WINS[c];and(a,d)==d&&(b[!(Math.floor(c/10)%2)*BOARD_QUADS+Math.floor(c/20)]=!0)}return b};
Board.prototype.findWin=function(){var a=this.turn==PLAYER1?this.p1:this.p2;if(4>bitCount(a))return!1;var b=not(or(this.p1,this.p2));if(!b)return!1;for(var c in LONG_MID_WINS){var d=LONG_MID_WINS[c],e=and(a,d);if(e==d){if(and(b,LONG_SPAN_WINS[c])||and(a,LONG_SPAN_WINS[c]))return Number(c)+1}else if(3==bitCount(e)&&and(a,LONG_SPAN_WINS[c])&&and(b,d))return Number(c)+1}for(c in SHORT_WINS)if(d=SHORT_WINS[c],e=and(a,d),e==d||4==bitCount(e)&&and(b,d))return Number(c)+71;return!1};
Board.prototype.getMoveFromMidWin=function(a){var b=this.turn==PLAYER1?this.p1:this.p2,c=not(or(this.p1,this.p2)),d=INVALID,e=INVALID,g=INVALID;95<a?d=MPOS_TO_IND[xor(SHORT_WINS[a-71],b)]:70<a?(a-=71,e=Math.floor(a/6),g=!(Math.floor(a/3)%2),a=SHORT_WINS[a],and(b,a)==a?(b=bitScan(c),d=b[0]):d=MPOS_TO_IND[xor(a,b)]):(a--,56>a&&(e=Math.floor(a/14),g=!(Math.floor(a/7)%2)),d=LONG_MID_WINS[a],a=LONG_SPAN_WINS[a],b=and(b,d)==d?and(b,a)==a?bitScan(and(c,a)):bitScan(c):bitScan(and(c,d)),d=b[0]);return{ind:d,
quad:e,dir:g}};
Board.prototype.findAllWins=function(){var a=bitCount(or(this.p1,this.p2));if(4>a||a>=BOARD_SPACES)return[];var a=[{},{}],b,c;this.turn==PLAYER1?(b=this.p1,c=this.p2):(b=this.p2,c=this.p1);var d=not(or(b,c)),e=Number(this.turn),g=Number(!e),f;for(f in QUAD_MID_WINS){var h=QUAD_MID_WINS[f];if(and(b,h)==h&&and(b,QUAD_SPAN_WINS[f])){var k=Math.floor(f/20),l=!(Math.floor(f/10)%2);a[e]["x_"+k+l]={ind:INVALID,quad:k,dir:l}}and(c,h)==h&&and(c,QUAD_SPAN_WINS[f])&&(k=Math.floor(f/20),l=!(Math.floor(f/10)%
2),a[g]["x_"+k+l]={ind:INVALID,quad:k,dir:l})}if(12>bitCount(b))for(f=0;f<BOARD_SPACES;f++)h=IND_TO_MPOS[f],and(b,h)&&testWinLineFromSpace(e,b,f,d,a),and(c,h)&&testWinLineFromSpace(g,c,f,d,a);else for(f=0;f<BOARD_SPACES;f++)h=IND_TO_MPOS[f],and(d,h)&&(testWinLineFromSpace(e,b,f,!1,a),testWinLineFromSpace(g,c,f,!1,a));return a};
function testWinLineFromSpace(a,b,c,d,e){for(var g in AVAIL_WINS[c]){var f=AVAIL_WINS[c][g],h=and(b,f);4<=bitCount(h)&&(h=xor(h,f),!d||and(d,h))&&(h=MPOS_TO_IND[h],meta=WIN_META[String(f)],void 0==meta?e[a][h+"_xx"]={ind:h,quad:INVALID,dir:INVALID}:e[a][h+"_"+meta[0]+(meta[1]==ROT_CLOCKWISE?"c":"a")]={ind:h,quad:meta[0],dir:meta[1]})}}
Board.prototype.deriveMove=function(a){var b,c,d,e;this.turn==PLAYER1?(b=this.p1,c=this.p2,d=a.p1,e=a.p2):(b=this.p2,c=this.p1,d=a.p2,e=a.p1);for(var g=bitCount(d),f=0;f<ALL_ROTATIONS;f++){a=Math.floor(f/2);var h=f%2,k=this.rotateQuad(b,a,h),l=this.rotateQuad(c,a,h),k=and(k,d);if(1==g-bitCount(k)&&l==e)return c=this.rotateQuad(d,a,!h),b=MPOS_TO_IND[xor(b,c)],{ind:b,quad:a,dir:h}}k=and(b,d);return 1==g-bitCount(k)&&c==e?(b=MPOS_TO_IND[xor(b,d)],{ind:b,quad:INVALID,dir:INVALID}):{ind:INVALID,quad:INVALID,
dir:INVALID}};Board.prototype.clone=function(){var a=new Board;a.p1=this.p1;a.p2=this.p2;a.turn=this.turn;return a};Board.prototype.print=function(){for(var a="",b=0;b<ROW_SPACES;b++){3==b&&(a+="-------\n");for(var c=0;c<COL_SPACES;c++){3==c&&(a+="|");var d=IND_TO_MPOS[IND[b][c]],e=":";and(this.p1,d)?e="X":and(this.p2,d)&&(e="O");a+=e}a+="\n"}console.log(a)};
Board.prototype.printMove=function(a){var b="";a.quad!=INVALID&&(b=" - Q"+a.quad+(a.dir==ROT_CLOCKWISE?"c":"a"));console.log("Move: "+ROW[a.ind]+","+COL[a.ind]+b)};Board.prototype.toString=function(){return"0x"+this.p1.toString(16)+",0x"+this.p2.toString(16)};var PLAYER_HUMAN=0,PLAYER_RANDOM=1,PLAYER_SIM=2,PLAYER_MCTS=3;function Player(a,b,c,d){this.game=a;this.board=b;this.player1=this.create(c);this.player2=this.create(d);this.player1Type=c;this.player2Type=d}Player.prototype.set=function(a,b){a==PLAYER1?this.player1=this.create(b):this.player2=this.create(b)};Player.prototype.create=function(a){switch(a){case PLAYER_RANDOM:return new Random(this.board);case PLAYER_SIM:return new Sim(this.board);case PLAYER_MCTS:return new MCTS(this.board)}return null};
Player.prototype.getType=function(){return this.board.turn==PLAYER1?this.player1Type:this.player2Type};Player.prototype.get=function(){return this.board.turn==PLAYER1?this.player1:this.player2};
Player.prototype.play=function(){var a=this.get();if(null!=a&&game.mode!=MODE_WIN){var b=a.getMove();this.board.isOpen(b.ind)?(this.game.cursorR=ROW[b.ind],this.game.cursorC=COL[b.ind],setTimeout(function(){this.game.onPlacePin(ROW[b.ind],COL[b.ind],!1);setTimeout(function(){game.mode!=MODE_WIN&&(this.game.arrowInd=dirToArrow(b.quad,b.dir),setTimeout(function(){this.game.onRotateStart(b.quad,b.dir,!1)},SETTING_AI_ROTATE_DELAY/2))},SETTING_AI_ROTATE_DELAY/2)},SETTING_AI_PLACE_DELAY)):(console.log(b.ind),
this.board.isOpen(b.ind)&&alert("not open: "+b.ind),this.game.onInvalidMove(b))}};function Random(a){this.board=a}Random.prototype.getMove=function(){var a=this.board.getOpen(),a=a[Math.floor(Math.random()*a.length)],b=Math.floor(Math.random()*BOARD_QUADS),c=Math.floor(2*Math.random());return{ind:a,quad:b,dir:c}};function Sim(a){this.board=a}Sim.prototype.getMove=function(){var a=this.board.clone(),b=a.findWin();if(b)return a=a.getMoveFromMidWin(b);a.makeRandomMove();return a=this.board.deriveMove(a)};var MAX_ITERATIONS=1E4,UCT_TUNING=0.9,VISITS_TO_ADD_NODE=1,MIN_FAIR_PLAY=0,INFINITY=1E6,WIN_SCORE=1,LOSE_SCORE=-1,TIE_SCORE=0;function MCTS(a){this.board=a}MCTS.prototype.getMove=function(){var a=this.board.findWin();if(a)return alert("win found"),this.board.getMoveFromMidWin(a);console.log("MCTS: Initial board");this.board.print();var a=this.runMCTS(this.board.clone()),b=this.board.deriveMove(a.board);console.log("Visits: "+a.visits+", Score: "+a.score);this.board.printMove(b);a.board.print();return b};
MCTS.prototype.runMCTS=function(a){var b={visits:1,score:0,board:a,parent:null,kids:[]};a=a.getAllNonLossMoves();if(0==a.length)return console.log("No non-loss moves found - making random"),b.board.makeRandomMove(),b;for(var c in a)b.kids.push({visits:0,score:0,board:a[c],parent:d,kids:[]});for(c=0;c<MAX_ITERATIONS;c++){var d=this.selectNode(b);d.visits>=VISITS_TO_ADD_NODE?this.expandNode(d):(a=this.simulate(d),this.backpropagate(d,a))}return this.pickFinalMove(b)};
MCTS.prototype.selectNode=function(a){for(var b=a;0<b.kids.length;){var c=-INFINITY,d=null,e=null==b.parent||0==b.parent.visits?1:b.parent.visits;for(i in b.kids){var g=b.kids[i];if(g.visits<=MIN_FAIR_PLAY){d=g;break}var f=g.score+Math.sqrt(Math.abs(UCT_TUNING*Math.log(e/g.visits)));f>c&&(c=f,d=g)}b=d;null==d&&(console.log(f),console.log("No best kid found - broken select! "+a.board.toString()))}return d};
MCTS.prototype.expandNode=function(a){var b=a.board;b.findWin()&&this.backpropagate(a,-INFINITY);b=b.getAllNonLossMoves();if(0==b.length)return TIE_SCORE;for(var c in b)a.kids.push({visits:0,score:0,board:b[c],parent:a,kids:[]})};MCTS.prototype.simulate=function(a){a=a.board.clone();for(var b=bitCount(or(a.p1,a.p2)),c=0;c<BOARD_SPACES-b;c++){if(a.findWin())return WIN_SCORE;a.makeRandomMove()}return TIE_SCORE};
MCTS.prototype.backpropagate=function(a,b){a.visits++;for(Math.abs(b)==INFINITY?a.score=b:a.score=(a.score*(a.visits-1)+b)/a.visits;null!=a.parent;)if(b*=-1,a=a.parent,a.visits++,b==INFINITY)a.score=INFINITY;else if(b==-INFINITY){var c=!0;for(i in a.kids)if(a.kids[i].score!=-INFINITY){c=!1;break}a.score=c?-INFINITY:LOSE_SCORE}else a.score=(a.score*(a.visits-1)+b)/a.visits};
MCTS.prototype.pickFinalMove=function(a){var b=-INFINITY,c=null,d;for(d in a.kids){var e=a.kids[d];e.visits>b&&(b=e.visits,c=e)}return null==c?a.kids[Math.floor(Math.rand()*a.kids.length)]:c};var SETTING_FIND_WINS=!0,SETTING_ROW_NUMBERS=!0,SETTING_ROW_NOTATION=!1,SETTING_ROT_ANIM=!0,SETTING_ROT_SPEED=3,SETTING_AI_PLACE_DELAY=300,SETTING_AI_ROTATE_DELAY=1E3,INVALID=-1,UNIT_SIZE=100,QUAD_SIZE=3*UNIT_SIZE,BOARD_SIZE=6*UNIT_SIZE,CANVAS_SIZE=800,CANVAS_OFFSET=(CANVAS_SIZE-BOARD_SIZE)/2,HALF_UNIT=UNIT_SIZE/2,HALF_QUAD=QUAD_SIZE/2,HALF_CANVAS=CANVAS_SIZE/2,ARROW_WIDTH=50,ARROW_HEIGHT=20,MODE_PLACE=0,MODE_ROTATE=1,MODE_ANIM=2,MODE_WAIT=3,MODE_WIN=4,COLOR_P1="#C00",COLOR_P2="#06c",COLOR_CURSOR=
"#cfc",COLOR_QUAD="#000",COLOR_GRID="#c0c0c0",COLOR_ARROW="#e0e0e0",COLOR_P1_WIN="#a00",COLOR_P2_WIN="#0cc",COLOR_TIE="#000",COLOR_ROW_NUMBERS="#c0c0c0",KEY_DELETE=46,KEY_ENTER=13,KEY_F=70,KEY_R=82,KEY_SPACE=32,requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(a){return setTimeout(a,1)},game;
function Game(){this.canvas=document.getElementById("mainCanvas");this.ctx=this.canvas.getContext("2d");this.ctx.font="14pt sans-serif";this.messageColor=COLOR_P1;this.message="Player1 - place marble";this.board=new Board;this.cursorC=this.cursorR=0;this.quadInd=this.arrowInd=INVALID;this.quadRotDir=this.quadRot=0;this.rotateMode=!1;this.winLines=null;this.status=$("#status");this.player=new Player(this,this.board,PLAYER_HUMAN,PLAYER_HUMAN);$(this.canvas).click(this.onClick);$(this.canvas).mousemove(this.onMouse);
$(document).keyup(this.onKeyPress);this.mode=this.player.getType()==PLAYER_HUMAN?MODE_PLACE:MODE_WAIT;this.player.play();this.onFrame()}
Game.prototype.onClick=function(a){void 0==a.offsetX?(x=a.pageX-$("#mainCanvas").offset().left,y=a.pageY-$("#mainCanvas").offset().top):(x=a.offsetX,y=a.offsetY);if(game.mode==MODE_PLACE||a.ctrlKey){var b=toRC(y),c=toRC(x);game.onPlacePin(b,c,a.ctrlKey)}else game.mode==MODE_ROTATE||a.altKey?(b=arrowToDir(game.quadInd,game.arrowInd),game.onRotateStart(game.quadInd,b,a.altKey)):game.mode==MODE_ANIM&&(game.quadRot=89*game.quadRotDir);game.draw()};
Game.prototype.onMouse=function(a){void 0==a.offsetX?(x=a.pageX-$("#mainCanvas").offset().left,y=a.pageY-$("#mainCanvas").offset().top):(x=a.offsetX,y=a.offsetY);game.mode==MODE_PLACE?(game.cursorR=toRC(y),game.cursorC=toRC(x),game.status.text(game.cursorR+", "+game.cursorC)):game.mode==MODE_ROTATE&&(game.quadInd=toQuad(x,y),game.arrowInd=toOctant(game.quadInd,x,y))};
Game.prototype.onKeyPress=function(a){if(a.keyCode==KEY_DELETE)game.mode==MODE_PLACE&&(a=IND[game.cursorR][game.cursorC],game.board.isOpen(a)||(a=not(IND_TO_MPOS[a]),game.board.p1=and(game.board.p1,a),game.board.p2=and(game.board.p2,a)));else if(a.keyCode==KEY_R)game.mode=MODE_ROTATE;else if(a.keyCode==KEY_SPACE)game.mode=MODE_PLACE;else if(a.keyCode==KEY_ENTER)game.onTurnChanged(!0);else a.keyCode==KEY_F&&game.showFindWins();game.draw()};
Game.prototype.onFrame=function(){if(this.mode==MODE_ANIM)this.onRotating();this.draw();requestAnimationFrame(this.onFrame.bind(this))};Game.prototype.onPlacePin=function(a,b,c){var d=this.board;if(d.set(a,b))if(a=d.isWin(),a==IN_PLAY)this.message="Player"+(this.board.turn+1)+" - turn quad",c||(this.mode=MODE_ROTATE);else this.onGameOver(a)};
Game.prototype.onRotateStart=function(a,b,c){this.quadInd=a;this.quadRot=0;this.quadRotDir=b==ROT_CLOCKWISE?1:-1;this.rotateMode=c;if(SETTING_ROT_ANIM)this.mode=MODE_ANIM;else this.onRotateEnd()};Game.prototype.onRotating=function(){if(90<=Math.abs(this.quadRot))this.onRotateEnd();else this.quadRot+=this.quadRotDir*SETTING_ROT_SPEED};Game.prototype.onRotateEnd=function(){this.board.rotate(this.quadInd,1==this.quadRotDir?ROT_CLOCKWISE:ROT_ANTICLOCKWISE);this.onTurnChanged(!1);this.onMoveOver()};
Game.prototype.onTurnChanged=function(a){a&&(this.board.turn=!this.board.turn);this.messageColor=this.board.turn==PLAYER1?COLOR_P1:COLOR_P2;this.message="Player"+(this.board.turn+1)+" - place marble"};Game.prototype.onMoveOver=function(){var a=this.board.isWin();if(a==IN_PLAY)SETTING_FIND_WINS&&this.showFindWins(),this.quadRot=0,this.arrowInd=this.quadInd=INVALID,this.cursorC=this.cursorR=0,this.rotateMode||(this.mode=this.player.getType()==PLAYER_HUMAN?MODE_PLACE:MODE_WAIT,this.player.play());else this.onGameOver(a)};
Game.prototype.onGameOver=function(a){var b=this.board.getWinLines();this.winLines=[[],[]];for(var c in b)for(var d in b[c]){var e=b[c][d],g=toXY(e[1])+HALF_UNIT,f=toXY(e[0])+HALF_UNIT,h=toXY(e[3])+HALF_UNIT,e=toXY(e[2])+HALF_UNIT;this.winLines[c].push([g,f,h,e])}if(a==WIN_TIE||a==WIN_DUAL)this.messageColor=COLOR_TIE,this.message="TIE GAME!";else if(a==WIN_PLAYER1?(this.winColor=COLOR_P1_WIN,this.messageColor=COLOR_P1,this.message="Player1 WINS!"):(this.winColor=COLOR_P2_WIN,this.messageColor=COLOR_P2,
this.message="Player2 WINS!"),1<b[PLAYER1].length||1<b[PLAYER2].length)this.message+=" Multi-win!";game.mode=MODE_WIN};Game.prototype.onInvalidMove=function(a){alert("invalid move");this.board.printMove(a)};
Game.prototype.draw=function(){var a=this.ctx;a.lineWidth=1;a.clearRect(0,0,CANVAS_SIZE,CANVAS_SIZE);a.fillStyle=this.messageColor;a.fillText(this.message,10,20);a.save();a.translate(CANVAS_OFFSET,CANVAS_OFFSET);SETTING_ROW_NUMBERS?this.drawRowNumbers(a):SETTING_ROW_NOTATION&&this.drawRowNotation(a);if(this.mode==MODE_PLACE){var b=toXY(this.cursorC),c=toXY(this.cursorR);a.fillStyle=COLOR_CURSOR;a.fillRect(b,c,UNIT_SIZE,UNIT_SIZE)}this.drawQuad(a,0,0,!1);this.drawQuad(a,1,0,!1);this.drawQuad(a,2,0,
!1);this.drawQuad(a,3,0,!1);a.strokeStyle=COLOR_QUAD;a.fillStyle=COLOR_QUAD;this.drawLine(a,QUAD_SIZE,0,QUAD_SIZE,BOARD_SIZE);this.drawLine(a,0,QUAD_SIZE,BOARD_SIZE,QUAD_SIZE);if(this.mode==MODE_ROTATE||this.mode==MODE_ANIM)this.drawArrow(a,-ARROW_HEIGHT,0,ARROW_WIDTH,ARROW_HEIGHT,292.5,4),this.drawArrow(a,0,-ARROW_HEIGHT,ARROW_WIDTH,ARROW_HEIGHT,157.5,0),this.drawArrow(a,BOARD_SIZE,-ARROW_HEIGHT,ARROW_WIDTH,ARROW_HEIGHT,22.5,1),this.drawArrow(a,BOARD_SIZE+ARROW_HEIGHT,0,ARROW_WIDTH,ARROW_HEIGHT,
247.5,5),this.drawArrow(a,0,BOARD_SIZE+ARROW_HEIGHT,ARROW_WIDTH,ARROW_HEIGHT,202.5,2),this.drawArrow(a,-ARROW_HEIGHT,BOARD_SIZE,ARROW_WIDTH,ARROW_HEIGHT,67.5,6),this.drawArrow(a,BOARD_SIZE+ARROW_HEIGHT,BOARD_SIZE,ARROW_WIDTH,ARROW_HEIGHT,112.5,7),this.drawArrow(a,BOARD_SIZE,BOARD_SIZE+ARROW_HEIGHT,ARROW_WIDTH,ARROW_HEIGHT,337.5,3);if(this.mode==MODE_ANIM)this.drawQuad(a,this.quadInd,this.quadRot,!0);else if(this.mode==MODE_WIN){for(var d in this.winLines[PLAYER1])this.drawWinLine(a,this.winLines[PLAYER1][d],
COLOR_P1_WIN);for(d in this.winLines[PLAYER2])this.drawWinLine(a,this.winLines[PLAYER2][d],COLOR_P2_WIN)}a.restore()};Game.prototype.drawLine=function(a,b,c,d,e){a.beginPath();a.moveTo(b,c);a.lineTo(d,e);a.closePath();a.stroke()};Game.prototype.drawCircle=function(a,b,c,d,e,g){a.beginPath();a.arc(b+d,c+d,d-e,0,2*Math.PI,!0);a.closePath();a.fillStyle=g;a.fill()};
Game.prototype.drawArrow=function(a,b,c,d,e,g,f){a.fillStyle=this.mode!=MODE_PLACE&&this.arrowInd==f?COLOR_CURSOR:COLOR_ARROW;a.save();f=e/2;a.translate(b,c);a.rotate(g*Math.PI/180);a.translate(-(d+e),0);a.fillRect(e,-f,d,e);a.beginPath();a.moveTo(0,0);a.lineTo(e,e);a.lineTo(e,-e);a.closePath();a.fill();a.restore()};
Game.prototype.drawQuad=function(a,b,c,d){if(this.mode!=MODE_ANIM||b!=this.quadInd||d){var e=this.board,g=Math.floor(b/QUAD_COUNT),f=b%QUAD_COUNT;b=g*QUAD_ROW_SPACES;var h=f*QUAD_COL_SPACES;a.save();a.translate(f*QUAD_SIZE+HALF_QUAD,g*QUAD_SIZE+HALF_QUAD);a.rotate(c*Math.PI/180);a.translate(-HALF_QUAD,-HALF_QUAD);d&&(a.fillStyle="#fff",a.fillRect(0,0,QUAD_SIZE,QUAD_SIZE));for(g=0;g<QUAD_ROW_SPACES;g++)for(d=toXY(g),a.strokeStyle=COLOR_GRID,this.drawLine(a,0,d,QUAD_SIZE,d),this.drawLine(a,d,0,d,QUAD_SIZE),
f=0;f<QUAD_COL_SPACES;f++){c=toXY(f);var k=e.get(b+g,h+f);k==PLAYER1?this.drawCircle(a,c,d,HALF_UNIT,5,COLOR_P1):k==PLAYER2&&this.drawCircle(a,c,d,HALF_UNIT,5,COLOR_P2)}d=toXY(QUAD_ROW_SPACES);this.drawLine(a,0,d,QUAD_SIZE,d);this.drawLine(a,d,0,d,QUAD_SIZE);a.restore()}};Game.prototype.drawRowNumbers=function(a){a.fillStyle=COLOR_ROW_NUMBERS;for(var b=0;b<ROW_SPACES;b++)a.fillText(b,-15,toXY(b)+HALF_UNIT),a.fillText(b,toXY(b)+HALF_UNIT,-5)};
Game.prototype.drawRowNotation=function(a){a.fillStyle=COLOR_ROW_NUMBERS;for(var b=0;b<ROW_SPACES;b++)a.fillText(COL_SPACES-b,-15,toXY(b)+HALF_UNIT),a.fillText(String.fromCharCode(65+b),toXY(b)+HALF_UNIT,BOARD_SIZE+20);a.fillText("X",HALF_QUAD,-5);a.fillText("Y",3*HALF_QUAD,-5);a.fillText("1",BOARD_SIZE+15,HALF_QUAD);a.fillText("2",BOARD_SIZE+15,3*HALF_QUAD)};Game.prototype.drawWinLine=function(a,b,c){a.strokeStyle=c;a.lineWidth=5;this.drawLine(a,b[0],b[1],b[2],b[3])};
Game.prototype.showFindWins=function(){var a=this.board.findAllWins();$("#find-wins-text").html("");for(var b in a){var c=a[b],d="",e;for(e in c){var g=c[e],f=g.ind==INVALID?"&lt;any&gt;":ROW[g.ind]+","+COL[g.ind],h=g.quad==INVALID?"":" - Q"+g.quad,k;g.dir==INVALID?k="":g.dir==ROT_CLOCKWISE?k=" Clockwise":g.dir==ROT_ANTICLOCKWISE&&(k=" Anti-clockwise");d+="<div>"+f+h+k+"</div>"}c=b==PLAYER1?COLOR_P1:COLOR_P2;$("#find-wins-text").append('<div style="color: '+c+'">'+d+"</div>")}};
function toXY(a){return a*UNIT_SIZE}function toRC(a){a=Math.floor((a-CANVAS_OFFSET)/UNIT_SIZE);return a>=ROW_SPACES?ROW_SPACES-1:0>a?0:a}function toQuad(a,b){return Math.floor(b/HALF_CANVAS)*QUAD_COUNT+Math.floor(a/HALF_CANVAS)}function toOctant(a,b,c){var d=0==a%QUAD_COUNT?0:CANVAS_SIZE,e=a<QUAD_COUNT?0:CANVAS_SIZE;b=(HALF_CANVAS-d)*(c-e)-(HALF_CANVAS-e)*(b-d);return 0==a%3?0<b?a+BOARD_QUADS:a:0>b?a+BOARD_QUADS:a}
function arrowToDir(a,b){return 0==a%3?b>=BOARD_QUADS?ROT_ANTICLOCKWISE:ROT_CLOCKWISE:b>=BOARD_QUADS?ROT_CLOCKWISE:ROT_ANTICLOCKWISE}function dirToArrow(a,b){return 0==a%3?b==ROT_ANTICLOCKWISE?BOARD_QUADS+a:a:b==ROT_CLOCKWISE?BOARD_QUADS+a:a};$(function(){game=new Game;$("#options-button").click(function(){var a=$("#options-button");a.hasClass("options-menu-down")?a.removeClass("options-menu-down"):a.addClass("options-menu-down");$("#options-menu").slideToggle()});$(".game-option").change(function(){var a=$(this).val();"speed"==$(this).attr("name")?SETTING_ROT_SPEED=a:0==a?SETTING_ROT_ANIM=!SETTING_ROT_ANIM:1==a?SETTING_ROW_NUMBERS=!SETTING_ROW_NUMBERS:2==a?SETTING_ROW_NOTATION=!SETTING_ROW_NOTATION:3==a&&(SETTING_FIND_WINS=!SETTING_FIND_WINS,
$("#find-wins").toggle())});$("#players select").change(function(){var a="player1"==$(this).attr("id")?PLAYER1:PLAYER2,b=Number($(this).val());game.player.set(a,b);game.player.play()})});
