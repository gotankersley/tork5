function xor(t,r){return(t/HI_MASK^r/HI_MASK)*HI_MASK+((t^r)>>>0)}function and(t,r){return(Math.floor(t/HI_MASK)&Math.floor(r/HI_MASK))*HI_MASK+((t&r)>>>0)}function or(t,r){return(Math.floor(t/HI_MASK)|Math.floor(r/HI_MASK))*HI_MASK+((t|r)>>>0)}function not(t){return(~Math.floor(t/HI_MASK)>>>0^4294967280)*HI_MASK+(~t>>>0)}function shiftL(t,r){return Math.floor(t*Math.pow(2,r))}function shiftR(t,r){return Math.floor(t/Math.pow(2,r))}function rotL(t,r){return t>>>32-r|(t<<r)%255}function rotR(t,r){return t>>>r|(t<<32-r>>>0)%255}function bitCount(t){var r=BIT_COUNTS[Math.floor(t/HI_MASK)];return t-=t>>>1&1431655765,t=(858993459&t)+(t>>>2&858993459),r+(16843009*(t+(t>>>4)&252645135)>>>24)}function bitScan(t){bits=[];var r=Math.floor(t/HI_MASK);for(t%=HI_MASK;t;){var o=t&-t;bits.push(MPOS_TO_POS[o>>>0]),t&=t-1}return bits.concat(HI_MPOS_TO_POS[r])}function Board(){this.p1=INITIAL,this.p2=INITIAL,this.turn=PLAYER1}function getSymMoveIds(t){for(var r=t.p1,o=t.p2,e=[0,0,0,0,0,0,0],a=[0,0,0,0,0,0,0],n=0;BOARD_SPACES>n;n++)for(var i=0;7>i;i++){var s=POS_TO_MPOS[n],_=POS_TO_MPOS[SYM_MAP[i][n]],A=e[i],S=a[i];and(r,s)&&(e[i]=xor(A,_)),and(o,s)&&(a[i]=xor(S,_))}var I=[];return I.push(String(e[0])+"_"+String(a[0])),I.push(String(e[1])+"_"+String(a[1])),I.push(String(e[2])+"_"+String(a[2])),I.push(String(e[3])+"_"+String(a[3])),I.push(String(e[4])+"_"+String(a[4])),I.push(String(e[5])+"_"+String(a[5])),I.push(String(e[6])+"_"+String(a[6])),I}function testWinLineFromSpace(t,r,o,e,a){for(var n=0;n<AVAIL_WINS[o].length;n++){var i=AVAIL_WINS[o][n],s=and(r,i),_=bitCount(s);if(_>=4){var A=xor(s,i);if(!e||and(e,A)){var S=MPOS_TO_POS[A];if(meta=WIN_META[String(i)],void 0==meta)a[t][S+"_xx"]={pos:S,quad:INVALID,rot:INVALID};else{var I=meta[1]==ROT_CLOCKWISE?"c":"a";a[t][S+"_"+meta[0]+I]={pos:S,quad:meta[0],rot:meta[1]}}}}}}function scoreWinLines(t,r,o,e){for(var a={},n=0,i=0;i<o.length;i++)for(var s=o[i],_=AVAIL_WINS[s],A=0;A<_.length;A++)a[_[A]]=!0;for(var S=Object.keys(a),i=0;i<S.length;i++)if(!and(r,S[i])){var I=bitCount(and(t,S[i]));n+=I>=e?INFINITY:I>=4?Math.pow(I,5):Math.pow(I,3)}return n}function Player(t,r,o,e){this.game=t,this.board=r,this.player1=o,this.player2=e,this.startTime=0,this.move=null}function initScoreMap(){scoreMap=[];for(var t=0;ROW_SPACES>t;t++){scoreMap.push([]);for(var r=0;COL_SPACES>r;r++)scoreMap[t].push([])}}function enableScoreMap(t,r){scoreBestR=ROW[t.pos],scoreBestC=COL[t.pos],scoreBestArrow=rotToArrow(t.quad,t.rot),game.message="Total: "+r,scoreEnabled=!0}function MC(t){this.board=t}function AlphaBeta(t){this.board=t}function negamaxSearch(t,r){if(r==ALPHA_BETA_MAX_DEPTH)return t.score();for(var o=-INFINITY,e=t.getAllMoves(),a=0;a<e.length;a++){var n=e[a];o=-Math.max(o,negamaxSearch(n,r+1))}return o}function Game(){this.canvas=document.getElementById("mainCanvas"),this.ctx=this.canvas.getContext("2d"),this.ctx.font="14pt sans-serif",this.messageColor=COLOR_P1,this.message="Player1 - place pin",this.board=new Board,this.cursorR=0,this.cursorC=0,this.arrow=INVALID,this.quad=INVALID,this.quadRotDegrees=0,this.quadRotDir=0,this.rotateMode=!1,this.winLines=null,this.wins=null,this.status=$("#status"),$(this.canvas).click(this.onClick),$(this.canvas).mousemove(this.onMouse),$(document).keyup(this.onKeyPress),this.player=new Player(this,this.board,PLAYER_HUMAN,PLAYER_HUMAN),this.mode=MODE_PLACE,this.player.play(),this.onFrame()}function drawArrow(t,r,o,e,a,n,i,s){t.fillStyle=s,t.save();var _=a/2;t.translate(r,o),t.rotate(n*Math.PI/180),t.translate(-(e+a),0),t.fillRect(a,-_,e,a),t.beginPath(),t.moveTo(0,0),t.lineTo(a,a),t.lineTo(a,-a),t.closePath(),t.fill(),t.restore()}function drawLine(t,r,o,e,a){t.beginPath(),t.moveTo(r,o),t.lineTo(e,a),t.closePath(),t.stroke()}function drawCircle(t,r,o,e,a,n){t.beginPath(),t.arc(r+e,o+e,e-a,0,2*Math.PI,!0),t.closePath(),t.fillStyle=n,t.fill()}function drawCurvedArrow(t,r,o,e,a,n,i,s,_){t.beginPath(),t.arc(r,o,e,a,n),t.stroke(),i?(drawLine(t,r+(e-2)*s,o+5*_,r+(e-15)*s,o+10*_),drawLine(t,r+e*s,o+5*_,r+(e+5)*s,o+15*_)):(drawLine(t,r+5*s,o+e*_,r+15*s,o+(e+5)*_),drawLine(t,r+5*s,o+e*_,r+10*s,o+(e-15)*_))}function toXY(t){return t*UNIT_SIZE}function toRC(t){var r=Math.floor((t-CANVAS_OFFSET)/UNIT_SIZE);return r>=ROW_SPACES?ROW_SPACES-1:0>r?0:r}function toQuad(t,r){var o=Math.floor(r/HALF_CANVAS),e=Math.floor(t/HALF_CANVAS);return o*QUAD_COUNT+e}function toOctant(t,r,o){var e=t%QUAD_COUNT==0?0:CANVAS_SIZE,a=QUAD_COUNT>t?0:CANVAS_SIZE,n=HALF_CANVAS,i=HALF_CANVAS,s=(n-e)*(o-a)-(i-a)*(r-e);return t%3==0?s>0?t+BOARD_QUADS:t:0>s?t+BOARD_QUADS:t}function arrowToRot(t,r){return t%3==0?r>=BOARD_QUADS?ROT_ANTICLOCKWISE:ROT_CLOCKWISE:r>=BOARD_QUADS?ROT_CLOCKWISE:ROT_ANTICLOCKWISE}function rotToArrow(t,r){return t%3==0?r==ROT_ANTICLOCKWISE?BOARD_QUADS+t:t:r==ROT_CLOCKWISE?BOARD_QUADS+t:t}var HI_MASK=4294967296,BIT_COUNTS=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4],POS_TO_MPOS=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648,4294967296,8589934592,17179869184,34359738368],MPOS_TO_POS={1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:7,256:8,512:9,1024:10,2048:11,4096:12,8192:13,16384:14,32768:15,65536:16,131072:17,262144:18,524288:19,1048576:20,2097152:21,4194304:22,8388608:23,16777216:24,33554432:25,67108864:26,134217728:27,268435456:28,536870912:29,1073741824:30,2147483648:31,4294967296:32,8589934592:33,17179869184:34,34359738368:35},HI_MPOS_TO_POS=[[],[32],[33],[32,33],[34],[32,34],[33,34],[32,33,34],[35],[32,35],[33,35],[32,33,35],[34,35],[32,34,35],[33,34,35],[32,33,34,35]],AVAIL_WINS=[[1543,1729,6151,98311,33816769,33816583,1573057,25166017,34493956369,34896609553,42949673233],[3590,14342,98822,1543,6151,98311,67633442,69206306,100663586,1342210058,1342210178,5368741898,17448337418],[3590,14342,98822,1543,1564,6151,98311,3145756,3145735,12582940,786460],[200968,148744,197e3,132488,147848,7340056,29360152,1835032,3145756,12582940,786460,1342210058,1342210088,5368741898,17448337418],[57392,98864,14384,49264,49180,66160,12400,7340056,29360152,1835032,3145756,3145840,12582940,786460,36641440016,43486544144,34493956369,34896609553,42949673233,34145296,34083856,34160656,2688016,42009616],[57392,98864,14384,49264,66160,12400,76022048,102760736,67633442,69206306,100663586,21475885216,21475885096,17449353376,5369757856],[49264,49345,66160,12400,50593984,1835200,29360320,33816769,33816688,1573057,25166017],[197e3,132488,147848,50593984,1835200,29360320,33816769,1573057,25166017,21475885216,21475885186,17449353376,5369757856],[200968,200992,200962,148744,197e3,196898,132488,147848,76022048,76022144,76022024,102760736,67633442,67633544,69206306,100663586,36641440016,36641440064,36641440004,43486544144,34493956369,34493956420,34896609553,42949673233],[3590,3608,3713,98822,1543,1564,1729,17314185728,17314090496,805405184,12885000704],[3590,3608,3713,1543,1564,1729,34628322304,35433628672,51539756032,34145296,34083856,2688016,42009616],[3590,3608,3713,14342,1610627072,1610616320,6442465280,402667520,68323328,71469056,67536896],[200968,200992,200962,3758108672,15032397824,939536384,1610627072,6442465280,402667520,144723968,144708608,176181248,136859648],[57392,57536,57356,14384,3758108672,15032397824,939536384,1610627072,1610670080,6442465280,402667520],[57392,57536,57356,49264,49345,49180,38923288576,52613496832,34628322304,35433628672,51539756032,144723968,144785408,176181248,136859648],[57392,57536,57356,98864,49264,49345,49180,25904119808,939622400,15032483840,17314185728,17314144256,805405184,12885000704,1342210058,1342210088,1342210178,5368741898,17448337418,85098496,71729152,68323328,71469056,67536896],[200968,200992,200962,197e3,196898,25904119808,939622400,15032483840,17314185728,805405184,12885000704,34145296,34160656,2688016,42009616],[200968,200992,200962,148744,197e3,196898,132488,147848,38923288576,38923337728,38923276288,52613496832,34628322304,34628374528,35433628672,51539756032,85098496,85066240,85073920,71729152,68323328,68297216,71469056,67536896],[404488192,453246976,1612447744,25771638784,50593984,50593795,50593840,1835200,33816769,33816583,33816688],[941096960,3759669248,25905594368,404488192,1612447744,25771638784,76022048,76022144,76022024,67633442,67633544,34145296,34083856,34160656,2688016],[941096960,3759669248,25905594368,404488192,409993216,1612447744,25771638784,7340056,7340128,7340038,1835032,3145756,3145840,3145735,21475885216,21475885186,21475885096,17449353376,5369757856,85098496,85066240,85073920,68323328,68297216],[52682555392,38992347136,51642368e3,34730934272,38757466112,7340056,7340128,7340038,3145756,3145840,3145735,144723968,144785408,144708608,136859648],[15044968448,25916604416,3770679296,12914262016,12892241920,17343447040,3250585600,7340056,7340128,7340038,29360152],[15044968448,25916604416,3770679296,12914262016,17343447040,3250585600,76022048,76022144,76022024,144723968,144785408,144708608,176181248],[12914262016,12935495680,17343447040,3250585600,50593984,50593795,50593840,29360320,85098496,85066240,85073920],[51642368e3,34730934272,38757466112,50593984,50593795,50593840,33816769,33816583,33816688,34145296,34083856,34160656,42009616],[52682555392,52688846848,52680982528,38992347136,51642368e3,51615629312,34730934272,38757466112,76022048,76022144,76022024,102760736,67633442,67633544,69206306,100663586,85098496,85066240,85073920,71729152,68323328,68297216,71469056,67536896],[941096960,945815552,973340672,25905594368,404488192,409993216,453246976,25904119808,25904023040,25904046080,939622400,17314185728,17314090496,17314144256,36641440016,36641440064,36641440004,34493956369,34493956420,144723968,144785408,144708608,176181248,136859648],[941096960,945815552,973340672,404488192,409993216,453246976,38923288576,38923337728,38923276288,34628322304,34628374528,1342210058,1342210088,1342210178,17448337418],[941096960,945815552,973340672,3759669248,3758108672,3758145536,3758099456,939536384,1610627072,1610670080,1610616320],[52682555392,52688846848,52680982528,3758108672,3758145536,3758099456,1610627072,1610670080,1610616320,1342210058,1342210088,1342210178,5368741898],[15044968448,15082717184,15035531264,3770679296,3758108672,3758145536,3758099456,15032397824,36641440016,36641440064,36641440004],[15044968448,15082717184,15035531264,12914262016,12935495680,12892241920,38923288576,38923337728,38923276288,21475885216,21475885186,21475885096,5369757856],[15044968448,15082717184,15035531264,25916604416,12914262016,12935495680,12892241920,25904119808,25904023040,25904046080,15032483840],[52682555392,52688846848,52680982528,51642368e3,51615629312,25904119808,25904023040,25904046080,17314185728,17314090496,17314144256,21475885216,21475885186,21475885096,17449353376],[52682555392,52688846848,52680982528,38992347136,51642368e3,51615629312,34730934272,38757466112,38923288576,38923337728,38923276288,52613496832,34628322304,34628374528,35433628672,51539756032,36641440016,36641440064,36641440004,43486544144,34493956369,34493956420,34896609553,42949673233]],MID_WINS=[1542,196872,49200,404226048,51608813568,12897484800,33816768,67633440,3145752,17314185216,34628321280,1610625024,1342210058,34493956368,21475885216,34145296,68321280,144723968],SPAN_WINS=[2049,4224,8256,537133056,1107296256,2164260864,16777217,8388610,4194308,8589935104,4294968320,2147485696,1073741826,2147483649,4294967424,33555456,16779264,8392704],LONG_MID_WINS=[1665,196866,49164,33816624,67633416,3145734,34493956356,1560,196896,49344,33816579,67633536,3145824,34493956416,98310,147720,12336,17314111488,34628308992,1610615808,68296704,6150,132360,66096,17314088448,34628370432,1610661888,68289024,436469760,51607240704,12888047616,25166016,100663584,786456,67534848,408944640,51615105024,12935233536,1573056,69206304,12582936,71467008,25771376640,38723911680,3233808384,12885000192,51539755008,402665472,42949673232,1612185600,34697379840,17326669824,805404672,35433627648,6442463232,34896609552,1542,196872,49200,404226048,51608813568,12897484800,33816768,67633440,3145752,17314185216,34628321280,1610625024,34493956368,68321280],LONG_SPAN_WINS=[2112,4128,8208,16777280,8388736,4194305,2147483712,2052,4098,8193,16777220,8388616,4194320,2147483652,513,1152,2112,8589967360,4295032832,2147484160,16777728,8193,16512,32832,8589936640,4294971392,2147491840,16785408,553648128,1082130432,2151677952,4194305,2097154,1048580,4196352,537919488,1074266112,2147745792,262145,33554434,16777220,264192,134479872,301989888,553648128,2147484160,1073742848,536872960,536870913,2147745792,4328521728,8606711808,134218240,17179870208,8589936640,8589934593,2049,4224,8256,537133056,1107296256,2164260864,16777217,8388610,4194308,8589935104,4294968320,2147485696,2147483649,16779264],SHORT_WINS=[1342210178,21475885096,34145284,1342210088,21475885186,34145344,1342185482,34160656,144708608,1342177802,34083856,144785408,21475098784,42009616,136859648,21479030944,2688016,176181248,17448337418,5369757856,8600440832,5368741898,17449353376,547377152,1342210058,21475885216,34145296,144723968],QUAD_MID_WINS=[1665,196866,49164,33816624,67633416,3145734,1342210178,34493956356,21475885096,34145284,1560,196896,49344,33816579,67633536,3145824,1342210088,34493956416,21475885186,34145344,98310,147720,12336,17314111488,34628308992,1610615808,1342185482,34160656,68296704,144708608,6150,132360,66096,17314088448,34628370432,1610661888,1342177802,34083856,68289024,144785408,436469760,51607240704,12888047616,25166016,100663584,786456,21475098784,42009616,67534848,136859648,408944640,51615105024,12935233536,1573056,69206304,12582936,21479030944,2688016,71467008,176181248,25771376640,38723911680,3233808384,12885000192,51539755008,402665472,17448337418,42949673232,5369757856,8600440832,1612185600,34697379840,17326669824,805404672,35433627648,6442463232,5368741898,34896609552,17449353376,547377152],QUAD_SPAN_WINS=[2112,4128,8208,16777280,8388736,4194305,1073741952,2147483712,4294967328,33555456,2052,4098,8193,16777220,8388616,4194320,1073741832,2147483652,4294967298,33555456,513,1152,2112,8589967360,4295032832,2147484160,1073741826,33619968,16777728,8389632,8193,16512,32832,8589936640,4294971392,2147491840,1073741826,33558528,16785408,8404992,553648128,1082130432,2151677952,4194305,2097154,1048580,4294967424,8389632,4196352,2101248,537919488,1074266112,2147745792,262145,33554434,16777220,4294967424,525312,264192,33558528,134479872,301989888,553648128,2147484160,1073742848,536872960,268435458,536870913,1073741952,8392704,2147745792,4328521728,8606711808,134218240,17179870208,8589936640,4294967298,8589934593,17179869312,8392704],SYM_MAP=[[24,23,22,21,20,19,18,25,26,33,32,31,30,29,28,27,34,35,6,5,4,3,2,1,0,7,8,15,14,13,12,11,10,9,16,17],[11,10,9,16,15,14,13,12,17,2,1,0,7,6,5,4,3,8,29,28,27,34,33,32,31,30,35,20,19,18,25,24,23,22,21,26],[31,30,29,28,27,34,33,32,35,13,12,11,10,9.16,15,14,17,22,21,20,19,18,25,24,23,26,4,3,2,1,0,7,6,5,8],[0,7,6,5,3,4,2,1,8,18,25,24,23,22,21,20,19,26,9,16,15,14,13,12,11,10,17,27,34,33,32,29,31,30,28,35],[24,25,18,19,20,21,22,23,26,6,7,0,1,2,3,4,5,8,33,34,27,28,29,30,31,32,35,15,16,9,10,11,12,13,14,17],[31,32,33,34,27,28,29,30,35,22,23,24,25,18,19,20,21,26,13,14,15,16,9,10,11,12,17,4,5,6,7,0,1,2,3,8],[11,12,13,14,15,16,9,10,17,29,30,31,32,33,34,27,28,35,2,3,4,5,6,7,0,1,8,20,21,22,23,24,25,18,19,26]],WIN_META={1564:[0,1],1729:[0,0],3608:[0,1],3713:[0,0],6151:[1,1],12400:[1,0],14342:[1,1],14384:[1,0],49180:[0,0],49345:[0,1],57356:[0,0],57536:[0,1],66160:[1,1],98311:[1,0],98822:[1,0],98864:[1,1],132488:[1,1],147848:[1,0],148744:[1,0],196898:[0,0],200962:[0,0],200992:[0,1],786460:[2,0],1573057:[2,1],1835032:[2,0],1835200:[2,1],2688016:[2,1],3145735:[0,0],3145840:[0,1],7340038:[0,0],7340128:[0,1],12582940:[2,1],25166017:[2,0],29360152:[2,1],29360320:[2,0],33816583:[0,1],33816688:[0,0],34083856:[1,1],34160656:[1,0],42009616:[2,0],50593795:[0,1],50593840:[0,0],67536896:[2,0],67633544:[0,0],68297216:[1,0],69206306:[2,1],71469056:[2,1],71729152:[2,0],76022024:[0,0],76022144:[0,1],85066240:[1,1],85073920:[1,0],100663586:[2,0],102760736:[2,0],136859648:[2,0],144708608:[1,0],144785408:[1,1],176181248:[2,1],402667520:[3,0],409993216:[2,1],453246976:[2,0],805405184:[3,1],939536384:[3,0],939622400:[3,1],945815552:[2,1],973340672:[2,0],1342210088:[0,1],1342210178:[0,0],1610616320:[1,0],1610670080:[1,1],1612447744:[3,1],3250585600:[3,0],3758099456:[1,0],3758145536:[1,1],3759669248:[3,1],3770679296:[3,0],34896609553:[3,1],42949673233:[3,0],5368741898:[3,1],17448337418:[3,0],17314090496:[1,1],12885000704:[3,0],35433628672:[3,1],51539756032:[3,0],6442465280:[3,1],21475885186:[0,1],17449353376:[3,1],5369757856:[3,0],36641440064:[0,1],36641440004:[0,0],43486544144:[3,0],34493956420:[0,0],15032483840:[3,0],38923337728:[1,1],38923276288:[1,0],52613496832:[3,0],34628374528:[1,0],15032397824:[3,1],21475885096:[0,0],17314144256:[1,0],25771638784:[3,0],25905594368:[3,0],25904023040:[1,1],25904046080:[1,0],34730934272:[3,1],38757466112:[3,0],52688846848:[2,1],52680982528:[2,0],38992347136:[3,0],51615629312:[2,0],12935495680:[2,1],17343447040:[3,1],25916604416:[3,1],12892241920:[2,0],15082717184:[2,1],15035531264:[2,0]},BOARD_SPACES=36,BOARD_QUADS=4,NUM_TO_WIN=5,ROW_SPACES=6,COL_SPACES=6,QUAD_SPACES=9,QUAD_COUNT=2,QUAD_ROW_SPACES=3,QUAD_COL_SPACES=3,ALL_ROTATIONS=8,EMPTY=-1,INVALID=-1,PLAYER1=0,PLAYER2=1,ROT_CLOCKWISE=0,ROT_ANTICLOCKWISE=1,IN_PLAY=0,WIN_PLAYER1=1,WIN_PLAYER2=2,WIN_TIE=3,WIN_DUAL=4,ROW=[0,0,0,1,2,2,2,1,1,0,0,0,1,2,2,2,1,1,3,3,3,4,5,5,5,4,4,3,3,3,4,5,5,5,4,4],COL=[0,1,2,2,2,1,0,0,1,3,4,5,5,5,4,3,3,4,0,1,2,2,2,1,0,0,1,3,4,5,5,5,4,3,3,4],POS=[[0,1,2,9,10,11],[7,8,3,16,17,12],[6,5,4,15,14,13],[18,19,20,27,28,29],[25,26,21,34,35,30],[24,23,22,33,32,31]],FULL=68719476735,INITIAL=0,QUADS=[255,130560,66846720,34225520640],WINS=[1543,3590,197e3,200968,49264,57392,404488192,941096960,51642368e3,52682555392,12914262016,15044968448,33816769,50593984,67633442,76022048,3145756,7340056,17314185728,25904119808,34628322304,38923288576,1610627072,3758108672,1342210058,34493956369,36641440016,21475885216,34145296,68323328,85098496,144723968];Board.prototype.isOpen=function(t){var r=not(or(this.p1,this.p2));return and(r,POS_TO_MPOS[t])},Board.prototype.set=function(t,r){var o=POS[t][r];return this.setPin(o)},Board.prototype.setPin=function(t){return this.isOpen(t)?(this.turn==PLAYER1?this.p1=xor(this.p1,POS_TO_MPOS[t]):this.p2=xor(this.p2,POS_TO_MPOS[t]),!0):!1},Board.prototype.get=function(t,r){var o=POS[t][r];return this.getPin(o)},Board.prototype.getPin=function(t){var r=POS_TO_MPOS[t];return and(this.p1,r)?PLAYER1:and(this.p2,r)?PLAYER2:EMPTY},Board.prototype.getOpen=function(){for(var t=[],r=not(or(this.p1,this.p2)),o=bitScan(r),e=0;e<o.length;e++)t.push(o[e]);return t},Board.prototype.rotate=function(t,r){this.p1=this.rotateQuad(this.p1,t,r),this.p2=this.rotateQuad(this.p2,t,r),this.turn=!this.turn},Board.prototype.rotateQuad=function(t,r,o){var e=and(t,QUADS[r]),a=shiftR(e,r*QUAD_SPACES),n=o==ROT_CLOCKWISE?rotL(a,QUAD_COUNT):rotR(a,QUAD_COUNT),i=shiftL(n,r*QUAD_SPACES);t=and(t,not(QUADS[r]));var s=xor(t,i);return s},Board.prototype.isWin=function(){var t=bitCount(or(this.p1,this.p2));if(t>=BOARD_SPACES)return WIN_TIE;if(NUM_TO_WIN>t)return IN_PLAY;for(var r=!1,o=!1,e=0;e<MID_WINS.length;e++){var a=MID_WINS[e];and(this.p1,a)==a&&and(this.p1,SPAN_WINS[e])?r=!0:and(this.p2,a)==a&&and(this.p2,SPAN_WINS[e])&&(o=!0)}return r&&o?WIN_DUAL:r?WIN_PLAYER1:o?WIN_PLAYER2:IN_PLAY},Board.prototype.canSkipRotation=function(){var t=or(this.p1,this.p2);return and(t,QUADS[0])&&and(t,QUADS[1])&&and(t,QUADS[2])&&and(t,QUADS[3])?!1:!0},Board.prototype.getWinLines=function(t){for(var r=[[],[]],o=0;o<MID_WINS.length;o++){var e=MID_WINS[o];if(and(this.p1,e)==e&&and(this.p1,SPAN_WINS[o])){var a=and(this.p1,SPAN_WINS[o]);r[PLAYER1].push(this.getWinLine(or(e,a)))}else if(and(this.p2,e)==e&&and(this.p2,SPAN_WINS[o])){var a=and(this.p2,SPAN_WINS[o]);r[PLAYER2].push(this.getWinLine(or(e,a)))}}return r},Board.prototype.getWinLine=function(t){for(var r,o,e=ROW_SPACES-1,a=COL_SPACES-1,n=0,i=0,s=bitScan(t),_=0;_<s.length;_++){var A=s[_];r=ROW[A],o=COL[A],(e>r||r==e&&a>o)&&(e=r,a=o),(r>n||r==n&&o>i)&&(n=r,i=o)}return[e,a,n,i]},Board.prototype.makeRandomMove=function(){var t=not(or(this.p1,this.p2)),r=bitScan(t),o=r[Math.floor(Math.random()*r.length)];this.turn==PLAYER1?this.p1=xor(this.p1,POS_TO_MPOS[o]):this.p2=xor(this.p2,POS_TO_MPOS[o]);var e=Math.floor(Math.random()*BOARD_QUADS),a=Math.floor(2*Math.random());this.rotate(e,a)},Board.prototype.makeDebugRandomMove=function(){var t=and(QUADS[2],not(or(this.p1,this.p2))),r=bitScan(t),o=r[Math.floor(Math.random()*r.length)];this.turn==PLAYER1?this.p1=xor(this.p1,POS_TO_MPOS[o]):this.p2=xor(this.p2,POS_TO_MPOS[o]);var e=Math.floor(Math.random()*BOARD_QUADS),a=Math.floor(2*Math.random());this.rotate(e,a)},Board.prototype.getAllMoves=function(){for(var t=not(or(this.p1,this.p2)),r=bitScan(t),o=[],e={},a=0;a<r.length;a++)for(var n=0;ALL_ROTATIONS>n;n++){var i=Math.floor(n/2),s=n%2,_=this.clone();_.turn==PLAYER1?_.p1=xor(_.p1,POS_TO_MPOS[r[a]]):_.p2=xor(_.p2,POS_TO_MPOS[r[a]]),_.rotate(i,s);var A=String(_.p1)+"_"+String(_.p2);"undefined"==typeof e[A]&&(e[A]=!0,o.push(_))}return o},Board.prototype.getAllDebugMoves=function(t){"undefined"==typeof t&&(t=6461620288),this.turn==PLAYER1&&(t=4311744512);for(var r=and(t,not(or(this.p1,this.p2))),o=bitScan(r),e=[],a=0;a<o.length;a++){var n=this.clone();n.turn==PLAYER1?n.p1=xor(n.p1,POS_TO_MPOS[o[a]]):n.p2=xor(n.p2,POS_TO_MPOS[o[a]]),n.turn=!n.turn,e.push(n)}return e},Board.prototype.getAllNonLossMoves=function(){var t,r,o=[],e={};this.turn==PLAYER1?(t=this.p1,r=this.p2):(t=this.p2,r=this.p1);for(var a=this.findOppRotateWins(r),n=not(or(t,r)),i=bitScan(n),s=0;s<i.length;s++)for(var _=0;ALL_ROTATIONS>_;_++)if(!a[_]){var A=Math.floor(_/2),S=_%2,I=this.clone();I.turn==PLAYER1?I.p1=xor(I.p1,POS_TO_MPOS[i[s]]):I.p2=xor(I.p2,POS_TO_MPOS[i[s]]),I.rotate(A,S);var O=String(I.p1)+"_"+String(I.p2);"undefined"==typeof e[O]&&(e[O]=!0,o.push(I))}return o},Board.prototype.getMoveFromMidWin=function(t){var r=this.turn==PLAYER1?this.p1:this.p2,o=not(or(this.p1,this.p2)),e=INVALID,a=INVALID,n=INVALID;if(t>95){var i=and(SHORT_WINS[t-71],r);e=MPOS_TO_POS[xor(SHORT_WINS[t-71],i)]}else if(t>70){t-=71,a=Math.floor(t/6),n=Math.floor(t/3)%2;var s=SHORT_WINS[t],i=and(r,s);if(i==s){var _=bitScan(o);e=_[0]}else e=MPOS_TO_POS[xor(s,i)]}else{t--,56>t&&(a=Math.floor(t/14),n=Math.floor(t/7)%2);var A=LONG_MID_WINS[t],S=LONG_SPAN_WINS[t];if(and(r,A)==A){var I=and(S,o),_=bitScan(I?I:o);e=_[0]}else{var _=bitScan(and(o,A));e=_[0]}}return{pos:e,quad:a,rot:n}},Board.prototype.getAllNonSymMoves=function(){for(var t=not(or(this.p1,this.p2)),r=bitScan(t),o=[],e={},a=0;a<r.length;a++)for(var n=0;ALL_ROTATIONS>n;n++){var i=Math.floor(n/2),s=n%2,_=this.clone();_.turn==PLAYER1?_.p1=xor(_.p1,POS_TO_MPOS[r[a]]):_.p2=xor(_.p2,POS_TO_MPOS[r[a]]),_.rotate(i,s);var A=String(_.p1)+"_"+String(_.p2);if("undefined"==typeof e[A]){e[A]=!0,o.push(_);var S=getSymMoveIds(_);e[S[0]]=!0,e[S[1]]=!0,e[S[2]]=!0,e[S[3]]=!0,e[S[4]]=!0,e[S[5]]=!0,e[S[6]]=!0}}return o},Board.prototype.findOppRotateWins=function(t){for(var r=[0,0,0,0,0,0,0,0],o=0;o<QUAD_MID_WINS.length;o++){var e=QUAD_MID_WINS[o];if(and(t,e)==e){var a=Math.floor(o/20),n=Math.floor(o/10)%2;r[n*BOARD_QUADS+a]=!0}}return r},Board.prototype.findWin=function(){var t=this.turn==PLAYER1?this.p1:this.p2,r=bitCount(t);if(4>r)return!1;var o=not(or(this.p1,this.p2));if(!o)return!1;for(var e=0;70>e;e++){var a=LONG_MID_WINS[e],n=and(t,a);if(n==a){if(and(o,LONG_SPAN_WINS[e])||and(t,LONG_SPAN_WINS[e]))return Number(e)+1}else if(3==bitCount(n)&&and(t,LONG_SPAN_WINS[e])&&and(o,a))return Number(e)+1}for(var e=0;28>e;e++){var i=SHORT_WINS[e],s=and(t,i);if(s==i)return Number(e)+71;if(4==bitCount(s)&&and(o,i))return Number(e)+71}return!1},Board.prototype.findAllWins=function(){var t=bitCount(or(this.p1,this.p2));if(4>t)return[];if(t>=BOARD_SPACES)return[];var r,o,e=[{},{}];this.turn==PLAYER1?(r=this.p1,o=this.p2):(r=this.p2,o=this.p1);for(var a=not(or(r,o)),n=Number(this.turn),i=Number(!n),s=0;s<QUAD_MID_WINS.length;s++){var _=QUAD_MID_WINS[s];if(and(r,_)==_&&and(r,QUAD_SPAN_WINS[s])){var A=Math.floor(s/20),S=Math.floor(s/10)%2;e[n]["x_"+A+S]={pos:INVALID,quad:A,rot:S}}if(and(o,_)==_&&and(o,QUAD_SPAN_WINS[s])){var A=Math.floor(s/20),S=Math.floor(s/10)%2;e[i]["x_"+A+S]={pos:INVALID,quad:A,rot:S}}}if(bitCount(r)<12)for(var I=0;BOARD_SPACES>I;I++){var O=POS_TO_MPOS[I];and(r,O)&&testWinLineFromSpace(n,r,I,a,e),and(o,O)&&testWinLineFromSpace(i,o,I,a,e)}else for(var I=0;BOARD_SPACES>I;I++){var O=POS_TO_MPOS[I];and(a,O)&&(testWinLineFromSpace(n,r,I,!1,e),testWinLineFromSpace(i,o,I,!1,e))}return e},Board.prototype.score=function(t){var r,o,e=0,a=0;this.turn==PLAYER2?(r=this.p1,o=this.p2):(r=this.p2,o=this.p1);var n=bitCount(or(r,o));if(20>=n)e=scoreWinLines(r,o,bitScan(r),5),a=scoreWinLines(o,r,bitScan(o),4);else{for(var i=0;i<MID_WINS.length;i++){var s=MID_WINS[i];if(and(r,s)==s&&and(r,SPAN_WINS[i])){e=INFINITY;break}if(and(o,s)==s&&and(o,SPAN_WINS[i])){a=INFINITY;break}}var _=not(or(r,o));e+=scoreWinLines(r,o,bitScan(_),5),a+=scoreWinLines(o,r,bitScan(_),4)}if("undefined"!=typeof t)return{cur:a,opp:e,total:a-e};var A=e-a;return A>=INFINITY?1:-INFINITY>=A?-1:A/INFINITY},Board.prototype.score2=function(){var t,r,o=0,e=0;this.turn==PLAYER2?(t=this.p1,r=this.p2):(t=this.p2,r=this.p1);for(var a=0;32>a;a++){if(!and(r,WINS[a])){var n=bitCount(and(t,WINS[a]));o+=Math.pow(n,5)}if(!and(t,WINS[a])){var n=bitCount(and(r,WINS[a]));e+=Math.pow(n,3)}return o-e}return o-e},Board.prototype.deriveMove=function(t){var r,o,e,a;this.turn==PLAYER1?(r=this.p1,o=this.p2,e=t.p1,a=t.p2):(r=this.p2,o=this.p1,e=t.p2,a=t.p1);for(var n=bitCount(e),i=0;ALL_ROTATIONS>i;i++){var s=Math.floor(i/2),_=i%2,A=this.rotateQuad(r,s,_),S=this.rotateQuad(o,s,_),I=and(A,e);if(n-bitCount(I)==1&&S==a){var O=this.rotateQuad(e,s,!_),h=MPOS_TO_POS[xor(r,O)];return{pos:h,quad:s,rot:_}}}var I=and(r,e);if(n-bitCount(I)==1&&o==a){var h=MPOS_TO_POS[xor(r,e)];return{pos:h,quad:INVALID,rot:INVALID}}return{pos:INVALID,quad:INVALID,rot:INVALID}},Board.prototype.toNNInputs=function(){for(var t=[],r=0;ROW_SPACES>r;r++)for(var o=0;COL_SPACES>o;o++){var e=POS_TO_MPOS[POS[r][o]];and(this.p1,e)?t.push(1):and(this.p2,e)?t.push(-1):t.push(0)}return t},Board.prototype.clone=function(){var t=new Board;return t.p1=this.p1,t.p2=this.p2,t.turn=this.turn,t},Board.prototype.print=function(){for(var t="",r=0;ROW_SPACES>r;r++){3==r&&(t+="-------\n");for(var o=0;COL_SPACES>o;o++){3==o&&(t+="|");var e=POS[r][o],a=POS_TO_MPOS[e],n=":";and(this.p1,a)?n="X":and(this.p2,a)&&(n="O"),t+=n}t+="\n"}console.log(t)},Board.prototype.printMove=function(t){var r="";if(t.quad!=INVALID){var o=t.rot==ROT_CLOCKWISE?"c":"a";r=" - Q"+t.quad+o}console.log("Move: "+ROW[t.pos]+","+COL[t.pos]+r)},Board.prototype.toString=function(){return this.p1+"_"+this.p2};var PLAYER_HUMAN=0,PLAYER_ALPHA_BETA=1,PLAYER_MC=2,PLAYER_MCTS=3,PLAYER_CPP=4,PLAYER_RANDOM=5,PLAYER_NN=6,PLAYER_MC2=7,PLAYER_SIM=8,PLAYERS=["Human","Weak","Good"],INFINITY=1e6;Player.prototype.set=function(t,r){t==PLAYER1?this.player1=r:this.player2=r},Player.prototype.getType=function(){return this.game.board.turn==PLAYER1?this.player1:this.player2},Player.prototype.create=function(t){switch(t){case PLAYER_HUMAN:return null;case PLAYER_RANDOM:return new Random(this.board);case PLAYER_SIM:return new Sim(this.board);case PLAYER_MC:return new MC(this.board);case PLAYER_MC2:return new MC2(this.board);case PLAYER_MCTS:return new MCTS(this.board);case PLAYER_CPP:return new CPP(this.board);case PLAYER_ALPHA_BETA:return new AlphaBeta(this.board)}return null},Player.prototype.play=function(){var t=this.getType();if(t!=PLAYER_HUMAN&&this.game.mode!=MODE_WIN){this.startTime=performance.now();var r=this.board;if(SETTING_PLAYER_WORKER){var o=new Worker("js/core/player-worker.js");o.onmessage=function(t){game.player.onPlayed(t.data)};var e={p1:r.p1,p2:r.p2,turn:r.turn,type:t};o.postMessage(e)}else{var a=this.create(t);this.move=a.getMove(r),SETTING_SHOW_SCORE_MAP?scoreEnabled||this.onPlayed():this.onPlayed()}}},Player.prototype.onPlayed=function(){var t=this.move,r=performance.now()-this.startTime,o=Math.max(0,SETTING_AI_PLACE_DELAY-r);console.log("Time: "+r/1e3+" seconds"),this.board.isOpen(t.pos)?(this.game.cursorR=ROW[t.pos],this.game.cursorC=COL[t.pos],setTimeout(function(){this.game.onPlacePin(ROW[t.pos],COL[t.pos],!1),setTimeout(function(){game.mode!=MODE_WIN&&(this.game.arrow=rotToArrow(t.quad,t.rot),setTimeout(function(){this.game.onRotateStart(t.quad,t.rot,!1)},SETTING_AI_ROTATE_DELAY/2))},SETTING_AI_ROTATE_DELAY/2)},o)):this.game.onInvalidMove(t)};var scoreEnabled=!1,scoreMap,scoreBestR,scoreBestC,scoreBestArrow,MC_SIMULATIONS=200,MC_SIM_DIST=!1,MC_FLAT=!0,MC_WIN_SCORE=1,MC_LOSE_SCORE=-1,MC_TIE_SCORE=0;MC.prototype.getMove=function(){var t=this.board.clone(),r=t.findWin();if(r)return scoreEnabled=!1,t.getMoveFromMidWin(r);initScoreMap();for(var o=t.getAllNonLossMoves(),e=-INFINITY,a=INVALID,n=0;n<o.length;n++){for(var i=0,s=0;MC_SIMULATIONS>s;s++)i+=this.simulate(o[n].clone());i>=e&&(e=i,a=n);var _=t.deriveMove(o[n]),A=ROW[_.pos],S=COL[_.pos];scoreMap[A][S].push({visits:MC_SIMULATIONS,score:i.toFixed(2)})}console.log("Best: "+e);var _;return a==INVALID?(alert("All moves lead to loss"),t.makeRandomMove(),_=this.board.deriveMove(t)):_=this.board.deriveMove(o[a]),enableScoreMap(_,o.length*MC_SIMULATIONS),_},MC.prototype.simulate=function(t){for(var r=bitCount(or(t.p1,t.p2)),o=t.turn,e=BOARD_SPACES-r,a=0;e>a;a++){var n=t.findWin();if(n)return t.turn!=o?MC_WIN_SCORE:MC_LOSE_SCORE;if(t.turn=!t.turn,n=t.findWin()){var i=t.getMoveFromMidWin(n);t.turn=!t.turn,t.setPin(i.pos),i.quad!=INVALID&&t.rotate(i.quad,i.rot)}else t.turn=!t.turn,t.makeRandomMove()}return MC_TIE_SCORE};var ALPHA_BETA_MAX_DEPTH=2;AlphaBeta.prototype.getMove=function(){var t=this.board.findWin();if(t)return scoreEnabled=!1,this.board.getMoveFromMidWin(t);this.board.print(),initScoreMap();for(var r=this.board.clone(),o=-INFINITY,e=null,a=r.getAllMoves(),n=0;n<a.length;n++){var i=a[n],s=i.score();s>o&&(o=s,e=i);var _=r.deriveMove(i),A=ROW[_.pos],S=COL[_.pos];scoreMap[A][S].push({visits:0,score:s})}scoreEnabled=!0,console.log("Score: "+o),e.print(),-INFINITY>=o&&(alert("All moves lead to loss - making random move"),this.board.makeRandomMove());var _=this.board.deriveMove(e);return enableScoreMap(_,a.length),_};var SETTING_FIND_WINS=!0,SETTING_ROW_NUMBERS=!0,SETTING_ROW_NOTATION=!1,SETTING_ROT_ANIM=!0,SETTING_ROT_SPEED=3,SETTING_AI_PLACE_DELAY=300,SETTING_AI_ROTATE_DELAY=1e3,SETTING_PLAYER_WORKER=!1,SETTING_SKIP_ROTATION=!0,SETTING_SHOW_SCORE_MAP=!1,UNIT_SIZE=100,QUAD_SIZE=3*UNIT_SIZE,BOARD_SIZE=6*UNIT_SIZE,CANVAS_SIZE=800,CANVAS_OFFSET=(CANVAS_SIZE-BOARD_SIZE)/2,HALF_UNIT=UNIT_SIZE/2,HALF_QUAD=QUAD_SIZE/2,HALF_CANVAS=CANVAS_SIZE/2,ARROW_WIDTH=50,ARROW_HEIGHT=20,MODE_PLACE=0,MODE_ROTATE=1,MODE_ANIM=2,MODE_WAIT=3,MODE_WIN=4,COLOR_P1="#c0c0c0",COLOR_P2="#000",COLOR_CURSOR="#cfc",COLOR_QUAD="#000",COLOR_GRID="#c0c0c0",COLOR_ARROW="#e0e0e0",COLOR_P1_WIN="#a00",COLOR_P2_WIN="#a00",COLOR_TIE="#000",COLOR_ROW_NUMBERS="#c0c0c0",COLOR_THREAT_WIN="#ccccff",COLOR_THREAT_LOSE="#ffcccc",KEY_DELETE=46,KEY_ENTER=13,KEY_F=70,KEY_R=82,KEY_S=83,KEY_SPACE=32,requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){return setTimeout(t,1)},game;Game.prototype.onClick=function(t){var r,o;if(void 0==t.offsetX?(r=t.pageX-$("#mainCanvas").offset().left,o=t.pageY-$("#mainCanvas").offset().top):(r=t.offsetX,o=t.offsetY),SETTING_SHOW_SCORE_MAP&&scoreEnabled)return game.player.getType()!=PLAYER_HUMAN&&game.player.onPlayed(),void(scoreEnabled=!1);if(game.mode==MODE_PLACE||t.ctrlKey){var e=toRC(o),a=toRC(r);game.onPlacePin(e,a,t.ctrlKey)}else if(game.mode==MODE_ROTATE||t.altKey){var e=toRC(o),a=toRC(r);if(SETTING_SKIP_ROTATION&&game.cursorR==e&&game.cursorC==a&&r>=UNIT_SIZE&&o>=UNIT_SIZE&&BOARD_SIZE+UNIT_SIZE>r&&BOARD_SIZE+UNIT_SIZE>o)game.board.canSkipRotation()?(game.onTurnChanged(!0),
game.onMoveOver()):game.message="Rotation required";else{var n=arrowToRot(game.quad,game.arrow);game.onRotateStart(game.quad,n,t.altKey)}}},Game.prototype.onMouse=function(t){var r,o;void 0==t.offsetX?(r=t.pageX-$("#mainCanvas").offset().left,o=t.pageY-$("#mainCanvas").offset().top):(r=t.offsetX,o=t.offsetY),game.mode==MODE_PLACE?(game.cursorR=toRC(o),game.cursorC=toRC(r),game.status.text(game.cursorR+", "+game.cursorC)):game.mode==MODE_ROTATE&&(game.quad=toQuad(r,o),game.arrow=toOctant(game.quad,r,o))},Game.prototype.onKeyPress=function(t){if(t.keyCode==KEY_DELETE){if(game.mode==MODE_PLACE){var r=POS[game.cursorR][game.cursorC];if(!game.board.isOpen(r)){var o=not(POS_TO_MPOS[r]);game.board.p1=and(game.board.p1,o),game.board.p2=and(game.board.p2,o)}}}else if(t.keyCode==KEY_R)game.mode=MODE_ROTATE;else if(t.keyCode==KEY_SPACE)game.mode=MODE_PLACE;else if(t.keyCode==KEY_ENTER)game.onTurnChanged(!0);else if(t.keyCode==KEY_F)SETTING_FIND_WINS=!0,game.wins=game.board.findAllWins();else if(t.keyCode==KEY_S){var e=game.board.score(!0);game.message="Score: "+e.cur+"/"+e.opp+" = "+e.total}},Game.prototype.onFrame=function(){this.mode==MODE_ANIM&&this.onRotating(),this.draw(),requestAnimationFrame(this.onFrame.bind(this))},Game.prototype.onPlacePin=function(t,r,o){var e=this.board;if(e.set(t,r)){var a=e.isWin();a==IN_PLAY?(this.message="Player"+(this.board.turn+1)+" - turn quad",o||(this.mode=MODE_ROTATE)):this.onGameOver(a)}},Game.prototype.onRotateStart=function(t,r,o){this.quad=t,this.quadRotDegrees=0,this.quadRotDir=r==ROT_CLOCKWISE?1:-1,this.rotateMode=o,SETTING_ROT_ANIM?this.mode=MODE_ANIM:this.onRotateEnd()},Game.prototype.onRotating=function(){Math.abs(this.quadRotDegrees)>=90?this.onRotateEnd():this.quadRotDegrees+=this.quadRotDir*SETTING_ROT_SPEED},Game.prototype.onRotateEnd=function(){var t=1==this.quadRotDir?ROT_CLOCKWISE:ROT_ANTICLOCKWISE;this.board.rotate(this.quad,t),this.rotateMode?this.mode=MODE_ROTATE:(this.onTurnChanged(!1),this.onMoveOver())},Game.prototype.onTurnChanged=function(t){t&&(this.board.turn=!this.board.turn),this.messageColor=this.board.turn==PLAYER1?COLOR_P1:COLOR_P2,this.message="Player"+(this.board.turn+1)+" - place pin"},Game.prototype.onMoveOver=function(){var t=this.board.isWin();t==IN_PLAY?(SETTING_FIND_WINS&&(this.wins=this.board.findAllWins()),this.quadRotDegrees=0,this.quad=INVALID,this.arrow=INVALID,this.cursorR=0,this.cursorC=0,this.mode=this.player.getType()==PLAYER_HUMAN?MODE_PLACE:MODE_WAIT,this.player.play()):this.onGameOver(t)},Game.prototype.onGameOver=function(t){var r=this.board.getWinLines();this.winLines=[[],[]];for(var o in r)for(var e in r[o]){var a=r[o][e],n=toXY(a[1])+HALF_UNIT,i=toXY(a[0])+HALF_UNIT,s=toXY(a[3])+HALF_UNIT,_=toXY(a[2])+HALF_UNIT;this.winLines[o].push([n,i,s,_])}t==WIN_TIE||t==WIN_DUAL?(this.messageColor=COLOR_TIE,this.message="TIE GAME!"):(t==WIN_PLAYER1?(this.winColor=COLOR_P1_WIN,this.messageColor=COLOR_P1,this.message="Player1 WINS!"):(this.winColor=COLOR_P2_WIN,this.messageColor=COLOR_P2,this.message="Player2 WINS!"),(r[PLAYER1].length>1||r[PLAYER2].length>1)&&(this.message+=" Multi-win!")),game.mode=MODE_WIN},Game.prototype.onInvalidMove=function(t){alert("invalid move"),this.board.printMove(t)},Game.prototype.draw=function(){var t=this.ctx;if(t.lineWidth=1,t.clearRect(0,0,CANVAS_SIZE,CANVAS_SIZE),t.fillStyle=this.messageColor,t.fillText(this.message,10,20),t.save(),t.translate(CANVAS_OFFSET,CANVAS_OFFSET),SETTING_ROW_NUMBERS?this.drawRowNumbers(t):SETTING_ROW_NOTATION&&this.drawRowNotation(t),this.mode==MODE_PLACE){var r=toXY(this.cursorC),o=toXY(this.cursorR);t.fillStyle=COLOR_CURSOR,t.fillRect(r,o,UNIT_SIZE,UNIT_SIZE)}if(this.drawQuad(t,0,0,!1),this.drawQuad(t,1,0,!1),this.drawQuad(t,2,0,!1),this.drawQuad(t,3,0,!1),t.strokeStyle=COLOR_QUAD,t.fillStyle=COLOR_QUAD,drawLine(t,QUAD_SIZE,0,QUAD_SIZE,BOARD_SIZE),drawLine(t,0,QUAD_SIZE,BOARD_SIZE,QUAD_SIZE),this.mode==MODE_ROTATE||this.mode==MODE_ANIM)for(var e=0;ALL_ROTATIONS>e;e++)this.drawArrow(t,e,this.arrow,COLOR_ARROW,COLOR_CURSOR);if(this.mode==MODE_ANIM)this.drawQuad(t,this.quad,this.quadRotDegrees,!0);else if(this.mode==MODE_WIN){for(var a in this.winLines[PLAYER1])this.drawWinLine(t,this.winLines[PLAYER1][a],COLOR_P1_WIN);for(var a in this.winLines[PLAYER2])this.drawWinLine(t,this.winLines[PLAYER2][a],COLOR_P2_WIN)}SETTING_FIND_WINS&&this.mode==MODE_PLACE&&this.wins&&this.drawWinThreats(t),t.restore()},Game.prototype.drawArrow=function(t,r,o,e,a){switch(r==o&&(e=a),r){case 0:drawArrow(t,0,-ARROW_HEIGHT,ARROW_WIDTH,ARROW_HEIGHT,157.5,0,e);break;case 1:drawArrow(t,BOARD_SIZE,-ARROW_HEIGHT,ARROW_WIDTH,ARROW_HEIGHT,22.5,1,e);break;case 2:drawArrow(t,0,BOARD_SIZE+ARROW_HEIGHT,ARROW_WIDTH,ARROW_HEIGHT,202.5,2,e);break;case 3:drawArrow(t,BOARD_SIZE,BOARD_SIZE+ARROW_HEIGHT,ARROW_WIDTH,ARROW_HEIGHT,337.5,3,e);break;case 4:drawArrow(t,-ARROW_HEIGHT,0,ARROW_WIDTH,ARROW_HEIGHT,292.5,4,e);break;case 5:drawArrow(t,BOARD_SIZE+ARROW_HEIGHT,0,ARROW_WIDTH,ARROW_HEIGHT,247.5,5,e);break;case 6:drawArrow(t,-ARROW_HEIGHT,BOARD_SIZE,ARROW_WIDTH,ARROW_HEIGHT,67.5,6,e);break;case 7:drawArrow(t,BOARD_SIZE+ARROW_HEIGHT,BOARD_SIZE,ARROW_WIDTH,ARROW_HEIGHT,112.5,7,e)}},Game.prototype.drawQuad=function(t,r,o,e){if(this.mode!=MODE_ANIM||r!=this.quad||e){var a=this.board,n=Math.floor(r/QUAD_COUNT),i=r%QUAD_COUNT,s=n*QUAD_ROW_SPACES,_=i*QUAD_COL_SPACES;t.save(),t.translate(i*QUAD_SIZE+HALF_QUAD,n*QUAD_SIZE+HALF_QUAD),t.rotate(o*Math.PI/180),t.translate(-HALF_QUAD,-HALF_QUAD),e&&(t.fillStyle="#fff",t.fillRect(0,0,QUAD_SIZE,QUAD_SIZE));for(var A,S,I=0;QUAD_ROW_SPACES>I;I++){S=toXY(I),t.strokeStyle=COLOR_GRID,drawLine(t,0,S,QUAD_SIZE,S),drawLine(t,S,0,S,QUAD_SIZE);for(var O=0;QUAD_COL_SPACES>O;O++){A=toXY(O);var h=a.get(s+I,_+O);h==PLAYER1?drawCircle(t,A,S,HALF_UNIT,5,COLOR_P1):h==PLAYER2&&drawCircle(t,A,S,HALF_UNIT,5,COLOR_P2)}}S=toXY(QUAD_ROW_SPACES),drawLine(t,0,S,QUAD_SIZE,S),drawLine(t,S,0,S,QUAD_SIZE),t.restore()}},Game.prototype.drawRowNumbers=function(t){t.fillStyle=COLOR_ROW_NUMBERS;for(var r=0;ROW_SPACES>r;r++)t.fillText(r,-15,toXY(r)+HALF_UNIT),t.fillText(r,toXY(r)+HALF_UNIT,-5)},Game.prototype.drawRowNotation=function(t){t.fillStyle=COLOR_ROW_NUMBERS;for(var r=0;ROW_SPACES>r;r++)t.fillText(COL_SPACES-r,-15,toXY(r)+HALF_UNIT),t.fillText(String.fromCharCode(65+r),toXY(r)+HALF_UNIT,BOARD_SIZE+20);t.fillText("X",HALF_QUAD,-5),t.fillText("Y",3*HALF_QUAD,-5),t.fillText("1",BOARD_SIZE+15,HALF_QUAD),t.fillText("2",BOARD_SIZE+15,3*HALF_QUAD)},Game.prototype.drawWinLine=function(t,r,o){t.strokeStyle=o,t.lineWidth=5,drawLine(t,r[0],r[1],r[2],r[3])},Game.prototype.drawScoreMap=function(t){t.fillStyle="#ff0000",t.font="10pt times";for(var r=0;ROW_SPACES>r;r++)for(var o=0;COL_SPACES>o;o++)for(var e=0;e<scoreMap[r][o].length;e++){var a=scoreMap[r][o][e];t.fillText(a.visits,o*UNIT_SIZE+5,r*UNIT_SIZE+15*(e+1)),t.fillText(a.score,o*UNIT_SIZE+HALF_UNIT,r*UNIT_SIZE+15*(e+1))}t.lineWidth=3,t.strokeStyle="#ff0000",t.beginPath(),t.rect(scoreBestC*UNIT_SIZE,scoreBestR*UNIT_SIZE,UNIT_SIZE,UNIT_SIZE),t.stroke(),this.drawArrow(t,scoreBestArrow,INVALID,"#ff0000")},Game.prototype.drawWinThreats=function(t){for(var r=0;r<this.wins.length;r++){var o=this.wins[r],e=r==game.board.turn?COLOR_THREAT_WIN:COLOR_THREAT_LOSE;for(var a in o){var n=o[a];if(n.pos==INVALID)this.drawArrow(t,rotToArrow(n.quad,n.rot),INVALID,e);else{var i=n.pos,s=ROW[i],_=COL[i],A=toXY(_),S=toXY(s),I=A+HALF_UNIT,O=S+HALF_UNIT;if(t.fillStyle=e,t.fillRect(A+12,S+12,3*UNIT_SIZE/4,3*UNIT_SIZE/4),n.quad!=INVALID){t.strokeStyle="#ffffff";var h=15;drawLine(t,I,S+h,I,S+UNIT_SIZE-h),drawLine(t,A+h,O,A+UNIT_SIZE-h,O);var d=rotToArrow(n.quad,n.rot);switch(d){case 0:drawCurvedArrow(t,I,O,30,Math.PI+.1,1.5*Math.PI-.1,!1,-1,-1);break;case 1:drawCurvedArrow(t,I,O,30,1.5*Math.PI+.1,-.1,!1,1,-1);break;case 2:drawCurvedArrow(t,I,O,30,.5*Math.PI+.1,Math.PI-.1,!1,-1,1);break;case 3:drawCurvedArrow(t,I,O,30,.1,.5*Math.PI-.1,!1,1,1);break;case 4:drawCurvedArrow(t,I,O,30,Math.PI+.1,1.5*Math.PI-.1,!0,-1,-1);break;case 5:drawCurvedArrow(t,I,O,30,1.5*Math.PI+.1,-.1,!0,1,-1);break;case 6:drawCurvedArrow(t,I,O,30,.5*Math.PI+.1,Math.PI-.1,!0,-1,1);break;case 7:drawCurvedArrow(t,I,O,30,.1,.5*Math.PI-.1,!0,1,1)}}}}}},Game.prototype.showFindWins=function(){var t=this.board.findAllWins();$("#find-wins-text").html("");for(var r in t){var o=t[r],e="";for(var a in o){var n,i=o[a],s=i.pos==INVALID?"&lt;any&gt;":ROW[i.pos]+","+COL[i.pos],_=i.quad==INVALID?"":" - Q"+i.quad;i.rot==INVALID?n="":i.rot==ROT_CLOCKWISE?n=" Clockwise":i.rot==ROT_ANTICLOCKWISE&&(n=" Anti-clockwise"),e+="<div>"+s+_+n+"</div>"}var A=r==PLAYER1?COLOR_P1:COLOR_P2;$("#find-wins-text").append('<div style="color: '+A+'">'+e+"</div>")}},$(function(){game=new Game,$("#options-button").click(function(){var t=$("#options-button");t.hasClass("options-menu-down")?t.removeClass("options-menu-down"):t.addClass("options-menu-down"),$("#options-menu").slideToggle()}),$(".game-option").change(function(){var t=$(this).val();"speed"==$(this).attr("name")?SETTING_ROT_SPEED=t:"abdepth"==$(this).attr("name")?(0>=t?t=1:t>3&&(alert("Maximum depth is 3"),t=3),ALPHA_BETA_MAX_DEPTH=t):0==t?SETTING_ROT_ANIM=!SETTING_ROT_ANIM:1==t?SETTING_ROW_NUMBERS=!SETTING_ROW_NUMBERS:3==t&&(SETTING_FIND_WINS=!SETTING_FIND_WINS)});for(var t in PLAYERS)$(".player").append('<option value="'+t+'">'+PLAYERS[t]+"</option>");$(".player").change(function(){var t="player1"==$(this).attr("id")?PLAYER1:PLAYER2,r=Number($(this).val());game.player.set(t,r),game.player.play()})});